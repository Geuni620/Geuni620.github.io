{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/2023/10/3/next-js-suspense-usequery/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<p><a href=\"https://github.com/Geuni620/suspense-fallback-ui\" target=\"_blank\" rel=\"nofollow\">실험 레포</a></p>\n<blockquote>\n<p>현재 진행 중인 프로젝트에서 Nav Bar에 user의 정보를 서버로 요청한 후 반환받아 보여줘야하는 게 있다.<br>\n이때 Nav Bar 내에서 useQuery로 데이터를 가져오는데, 새로고침을 하면 Suspense를 적용해서 fallback ui를 보여주고자 했다.<br>\n하지만 fallback ui가 보이지 않는다. 그래서 테스트해보기 시작했다.</p>\n</blockquote>\n<br>\n<h3 id=\"구성요소\" style=\"position:relative;\"><a href=\"#%EA%B5%AC%EC%84%B1%EC%9A%94%EC%86%8C\" aria-label=\"구성요소 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>구성요소</h3>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// app/page.tsx</span>\n<span class=\"token string\">'use client'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> UsequeryComp <span class=\"token keyword\">from</span> <span class=\"token string\">'app/components/UsequeryComp'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Suspense <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">Home</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Suspense</span></span> <span class=\"token attr-name\">fallback</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">useQuery loading...</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>flex items-center justify-center bg-blue-500<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UsequeryComp</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Suspense</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>먼저 root page에 client-components로 변경시켜주고, <code class=\"language-text\">UsequeryComp</code>를 Suspense로 감싸줬다.</li>\n<li>여기서 <code class=\"language-text\">UsequeryComp</code>는 다음과 같이 구성했다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// app/components/UsequeryComp.tsx</span>\n<span class=\"token string\">'use client'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useQuery <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@tanstack/react-query'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> axiosPostQuery <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'app/api/route'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Post <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@/type'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">UsequeryComp</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data<span class=\"token operator\">:</span> posts <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'posts'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> axiosPostQuery<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ul</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token punctuation\">{</span>posts<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>post<span class=\"token operator\">:</span> Post<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span> <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>post<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>post<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ul</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> UsequeryComp<span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>그리고 <code class=\"language-text\">axiosPostQuery</code>는 다음과 같이 구성했다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// app/api/route.ts</span>\n<span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">wait</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>ms<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> ms<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">axiosPostQuery</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">await</span> <span class=\"token function\">wait</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 명확히 fallback ui를 확인하기 위해 wait를 걸어줬다.</span>\n\n  <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">'https://jsonplaceholder.typicode.com/posts'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>axiosPostQuery를 사용한 이유는, next.js 13 version의 fetch는 Web API인 <strong>fetch와 조금 다르기 때문이다.</strong></li>\n<li>next.js app디렉토리에 맞게 cache 등이 포함된 확장된 <a href=\"https://nextjs.org/docs/app/api-reference/functions/fetch\" target=\"_blank\" rel=\"nofollow\">fetch API</a> 이다.</li>\n<li>그래서 순수하게 cache 설정을 따로 하지 않은 axios를 설치해서 사용했다.</li>\n</ul>\n<br>\n<h3 id=\"원하는-동작\" style=\"position:relative;\"><a href=\"#%EC%9B%90%ED%95%98%EB%8A%94-%EB%8F%99%EC%9E%91\" aria-label=\"원하는 동작 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>원하는 동작</h3>\n<ul>\n<li>원하는 동작은 심플하다.</li>\n</ul>\n<blockquote>\n<p>새로고침을 할 때마다 fallback ui가 보여야한다.</p>\n</blockquote>\n<ul>\n<li>원인을 파악할 수 없어, <code class=\"language-text\">react</code>로 동일하게 구성했었다.<br>\n<code class=\"language-text\">* react는 위 실험레포에서 branch로 분리시켜놓았다.</code></li>\n<li>react는 새로고침할 때마다 suspesne의 fallback ui가 띄워진다.</li>\n<li>하지만 next.js를 새로고침할 때마다 suspesne fallback ui를 띄우다가 어느순간엔 <strong>즉시 데이터를 반환해버린다.</strong></li>\n</ul>\n<br>\n<h3 id=\"원인파악-중\" style=\"position:relative;\"><a href=\"#%EC%9B%90%EC%9D%B8%ED%8C%8C%EC%95%85-%EC%A4%91\" aria-label=\"원인파악 중 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>원인파악 중</h3>\n<ul>\n<li>현재 원인을 계속 파악하는 중이다.</li>\n<li>cache 되었는게 분명하긴 한데, 어디서 어떻게 cache 된 것인지 모르겠다.</li>\n<li>network tab에서 <code class=\"language-text\">disable cache</code>옵션을 체크했는데도 불구하고 새로고침을 연발하다보면, 즉시 데이터를 반환한다.</li>\n<li>의아해서 Nav Bar를 만들고 페이지 라우팅을 시켜보았는데, 페이지 라우팅을 시키면 Suspense의 fallback UI가 돌기시작한다.</li>\n</ul>\n<br>\n<h3 id=\"network-tab-확인하기\" style=\"position:relative;\"><a href=\"#network-tab-%ED%99%95%EC%9D%B8%ED%95%98%EA%B8%B0\" aria-label=\"network tab 확인하기 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Network tab 확인하기</h3>\n<p>network tab의 <code class=\"language-text\">throttling</code>도 걸어보고, <code class=\"language-text\">disable cache</code>도 적용해보았는데,<br>\n이번엔 <strong>localhost로 가져오는 HTML를 확인</strong>해보기로 했다.</p>\n<p>왜냐하면, 서버컴포넌트는, 서버에서 HTML를 그려서 가져올테니까, 데이터 fetching이 끝나지 않았다면, Suspense가 컴포넌트를 그리다가 중단하고 다른 컴포넌트부터 그리게 되고,<br>\n컴포넌트가 다 그려지면 다시 Suspense로 돌아와서 해당 데이터가 resolve 되었는지 확인한다.<br>\nresolve 되지 않았다면 fallback ui를 보여줄 것이다.<br>\n<a href=\"https://geuni620.github.io/blog/2023/9/8/useQuery%20vs%20userQuery+Suspense/#%EC%97%AC%EA%B8%B0%EC%84%9C-%EC%9E%A0%EA%B9%90%EB%A7%8C\" target=\"_blank\" rel=\"nofollow\">위 내용은 이전 블로그 글에서 작성한 내용이다.</a></p>\n<br>\n<p>그럼 fallback ui인 loading이라고 찍혀있어야하지 않을까?</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a24422567de1b880833ac8d9b1a011eb/98c82/client-query-fallback.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.166666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAyklEQVQY043PvU7DMBSGYd8wQ2fExsZNIJjpyoXAWKrWTYWqJNhpLfkntl9kl0YwpOKT3vXROeJ+uWfxJLl5lCyeG+6WitsXzcOrRp9GtI7oU8S4SIzpeikh9jtJ336iugODaiF7YKwpZXh7P9A0LcdBUZZzno2cEVvZoIcjKWV8GHHO16x1xFjgSErlukgmn1HmJ6Tc0fVfKKXx3v8UcM5V5PfOR+SridXHmq7vKxBCmCrwBZxemuD5G8VmKzHGVKCgl6y1f8D/7htCMtClD86ppQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/a24422567de1b880833ac8d9b1a011eb/a59e9/client-query-fallback.webp 192w,\n/static/a24422567de1b880833ac8d9b1a011eb/0ca9f/client-query-fallback.webp 384w,\n/static/a24422567de1b880833ac8d9b1a011eb/dc9b9/client-query-fallback.webp 768w,\n/static/a24422567de1b880833ac8d9b1a011eb/e2c2f/client-query-fallback.webp 1152w,\n/static/a24422567de1b880833ac8d9b1a011eb/592a3/client-query-fallback.webp 1456w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/a24422567de1b880833ac8d9b1a011eb/3b721/client-query-fallback.png 192w,\n/static/a24422567de1b880833ac8d9b1a011eb/66595/client-query-fallback.png 384w,\n/static/a24422567de1b880833ac8d9b1a011eb/fe486/client-query-fallback.png 768w,\n/static/a24422567de1b880833ac8d9b1a011eb/d2d74/client-query-fallback.png 1152w,\n/static/a24422567de1b880833ac8d9b1a011eb/98c82/client-query-fallback.png 1456w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/a24422567de1b880833ac8d9b1a011eb/fe486/client-query-fallback.png\"\n            alt=\"첫 loading 시\"\n            title=\"첫 loading 시\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">첫 loading 시</figcaption>\n  </figure></p>\n<ul>\n<li>위 이미지 처럼 fallback ui가 잘 보여지는 것을 확인 할 수 있다.</li>\n</ul>\n<br>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/13afe0ef7b974387514e4ceee69a7ef1/98c82/client-query-data.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.166666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABKklEQVQY012Qy07CQBSG+/5v4IIXkMSNLoiX6EIXLBRRpMVguAhSWnuZtkxbOtPPdBAVJ/ly5mQyX/5zLHs05n3xwXK1xvV8so1kI3M2UiLzijjWpBLyCmp+z9+76esapTSW7y4QwRoRuGTiE6i+2SKlYjbLWa1ChIiIoog4jg1CiAOyLDNi6+Ruztl9wI1TcjWUnD+ndJ5Srl8SKqURIqDff8S2bfNpL0iS5KBKKXfC9u2S1sWco86M1uWCdjfmuJtw+iAotgrf9xkObUajEZPJxPT7hEEQmNRhGFKW5U74Nn7Fc5eI0CeNA1AF1FtqVaC1xvM8BoOBSdjU/diNsHn/v0crigUyL34WrXRtqCqF1jWu69Lr9XAcxwin06kZL8/zH2EjamgSfgFxNcVotINTpwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/13afe0ef7b974387514e4ceee69a7ef1/a59e9/client-query-data.webp 192w,\n/static/13afe0ef7b974387514e4ceee69a7ef1/0ca9f/client-query-data.webp 384w,\n/static/13afe0ef7b974387514e4ceee69a7ef1/dc9b9/client-query-data.webp 768w,\n/static/13afe0ef7b974387514e4ceee69a7ef1/e2c2f/client-query-data.webp 1152w,\n/static/13afe0ef7b974387514e4ceee69a7ef1/592a3/client-query-data.webp 1456w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/13afe0ef7b974387514e4ceee69a7ef1/3b721/client-query-data.png 192w,\n/static/13afe0ef7b974387514e4ceee69a7ef1/66595/client-query-data.png 384w,\n/static/13afe0ef7b974387514e4ceee69a7ef1/fe486/client-query-data.png 768w,\n/static/13afe0ef7b974387514e4ceee69a7ef1/d2d74/client-query-data.png 1152w,\n/static/13afe0ef7b974387514e4ceee69a7ef1/98c82/client-query-data.png 1456w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/13afe0ef7b974387514e4ceee69a7ef1/fe486/client-query-data.png\"\n            alt=\"새로고침 했을 때\"\n            title=\"새로고침 했을 때\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">새로고침 했을 때</figcaption>\n  </figure></p>\n<ul>\n<li>새로고침을 하면 데이터가 caching되어 fallback ui를 보여주지 않는다.</li>\n</ul>\n<br>\n<h3 id=\"서버-컴포넌트는\" style=\"position:relative;\"><a href=\"#%EC%84%9C%EB%B2%84-%EC%BB%B4%ED%8F%AC%EB%84%8C%ED%8A%B8%EB%8A%94\" aria-label=\"서버 컴포넌트는 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>서버 컴포넌트는?</h3>\n<ul>\n<li>위의 테스트는 클라이언트 컴포넌트를 테스트해본 것이다.</li>\n<li>그럼 서버컴포넌트도 동일하게 suspense로 감싸줬을 때 fallback ui를 잘 띄워줄까?</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// app/server</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Suspense <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> UseServerComp <span class=\"token keyword\">from</span> <span class=\"token string\">'../components/server/UseServerComp'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">Home</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Suspense</span></span> <span class=\"token attr-name\">fallback</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">...server loading</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>flex items-center justify-center bg-yellow-400<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UseServerComp</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Suspense</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// app/components/server/UseServerComp.tsx</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Post <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@/type'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> serverPostQuery <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../api/route'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> UseServerComp<span class=\"token operator\">:</span> React<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">FC</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> posts <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">serverPostQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ul</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token punctuation\">{</span>posts<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>post<span class=\"token operator\">:</span> Post<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>li</span> <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>post<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>post<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>li</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ul</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> UseServerComp<span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>위와 같이 server components를 구성해줬다.</li>\n<li>똑같이 network tab에서 이미지</li>\n</ul>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bce5ade2b33c668b03815cdb9a1f2a39/ed887/server-comp-fallback.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAwElEQVQY03WOy26DMBQF+f/f66oRJeSBA9jGxgZTnlPFClEX4UqjszpzT/L1nXETJaXUL1TkUUtkY2idxTiLkJpKNUilUY1BGxuplcY6TxcGfB9ITnlJmp1Js5xTmiEeFV3XY1tHGAaqeib9CdyLXzaOb9s21nUlkUVBfrlibUvrHCEE5nlmmqaIMR1FoZDSxtIRz1uWhUSKjNtd4L1nHMcoeebOpyVHwriwFILz5UpVS/q+fy/bhZ+Ke/5/sgv/AJPkgpSAe3hkAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/bce5ade2b33c668b03815cdb9a1f2a39/a59e9/server-comp-fallback.webp 192w,\n/static/bce5ade2b33c668b03815cdb9a1f2a39/0ca9f/server-comp-fallback.webp 384w,\n/static/bce5ade2b33c668b03815cdb9a1f2a39/dc9b9/server-comp-fallback.webp 768w,\n/static/bce5ade2b33c668b03815cdb9a1f2a39/e2c2f/server-comp-fallback.webp 1152w,\n/static/bce5ade2b33c668b03815cdb9a1f2a39/0e833/server-comp-fallback.webp 1484w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/bce5ade2b33c668b03815cdb9a1f2a39/3b721/server-comp-fallback.png 192w,\n/static/bce5ade2b33c668b03815cdb9a1f2a39/66595/server-comp-fallback.png 384w,\n/static/bce5ade2b33c668b03815cdb9a1f2a39/fe486/server-comp-fallback.png 768w,\n/static/bce5ade2b33c668b03815cdb9a1f2a39/d2d74/server-comp-fallback.png 1152w,\n/static/bce5ade2b33c668b03815cdb9a1f2a39/ed887/server-comp-fallback.png 1484w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/bce5ade2b33c668b03815cdb9a1f2a39/fe486/server-comp-fallback.png\"\n            alt=\"server components\"\n            title=\"server components\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">server components</figcaption>\n  </figure></p>\n<ul>\n<li>동일하게 첫 로딩시 Suspense가 잘 돌기 시작한다.</li>\n<li>하지만, 위의 useQuery + Suspense를 감싸줬을 때와는 다르게 새로고침할 때마다 fallback ui가 잘 보인다.</li>\n</ul>\n<br>\n<h3 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h3>\n<ul>\n<li>결국 <strong>next.js app directory는 client components / server components 모두 suspense를 지원한다.</strong></li>\n<li>하지만 client components 중 useQuery + Suspense는 cache Time을 0으로 설정해줬어도, cache 되어서 새로고침했을 때 바로 데이터를 반환하는 경우가 있다.</li>\n<li>이럴 경우에 새로고침할 때마다 loading fallback을 보여주려면 다음과 같이 구성해주면 된다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token string\">'use client'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// import UsequeryComp from 'app/components/UsequeryComp';</span>\n<span class=\"token keyword\">import</span> dynamic <span class=\"token keyword\">from</span> <span class=\"token string\">'next/dynamic'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Suspense <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> UsequeryComp <span class=\"token operator\">=</span> <span class=\"token function\">dynamic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./components/UsequeryComp'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  ssr<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">loading</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">useQuery loading...</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">Home</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>flex items-center justify-center bg-blue-500<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UsequeryComp</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>위와 같이 구성해주면 dynamic import 내 Suspense가 포함되어있어 loading fallback을 새로고침할 때마다 보여줄 수 있었다.</li>\n<li>하지만 useQuery + Suspense를 사용하면 새로고침 연발하다가 어느순간 cache 된 데이터를 즉시 반환한다.\n<ul>\n<li><code class=\"language-text\">이게 원인이 무엇인지 모르겠다. ㅠㅠ, cache 된 거 같은데, query가? next가? 어떻게 cache 된 건지 원인을 모르겠다.</code></li>\n</ul>\n</li>\n</ul>\n<br>\n<h3 id=\"번외\" style=\"position:relative;\"><a href=\"#%EB%B2%88%EC%99%B8\" aria-label=\"번외 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>번외</h3>\n<blockquote>\n<p>맨 처음 ‘이때 Nav Bar 내에서 useQuery로 데이터를 가져오는데, 새로고침을 하면 Suspense를 적용해서 fallback ui를 보여주고자 했다.‘에 대한 원인은 다음과 같다.</p>\n</blockquote>\n<ul>\n<li>next-auth를 통해 useSession hooks으로 user의 email을 가져와서 api 요청시 params에 넣어 함께 요청을 보낸다.</li>\n<li>이때 다음과 같이 useQuery를 설정했다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useUserInfoGetQuery</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>userEmail<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> userInfo <span class=\"token operator\">=</span> <span class=\"token function\">useQuery</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>userManagerKeys<span class=\"token punctuation\">.</span>userInfo<span class=\"token punctuation\">,</span> userEmail<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span>userEmail<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      enabled<span class=\"token operator\">:</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span>userEmail<span class=\"token punctuation\">,</span> <span class=\"token comment\">// enabled</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> userInfo<span class=\"token operator\">:</span> userInfo<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span> isLoading<span class=\"token operator\">:</span> userInfo<span class=\"token punctuation\">.</span>isLoading <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>주석으로 표시해두었듯이, useEmail이 존재할 때만 useQuery가 api를 요청한다.</li>\n<li>즉, userEmail 또한 session에 userEmail을 가져와서 요청을 보내야한다.</li>\n<li>Suspense로 감싸줬다 한 들, userEmail이 없다면 Suspense가 돌지 않는다.</li>\n<li>아마 이것 때문이었던 것 같다. userEmail이 없는 상태라서 useQuery가 돌지 않았다.</li>\n<li>그래서 Nav 요청을 보낼 때 userEmail을 mocking으로 넣어주고 테스트를 진행했다.</li>\n</ul>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 764px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aff0aa024d21374a8e2146d6768663c9/2cbcd/remove-enabled.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.4375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA9ElEQVQY04WNy0rDQBiF89L6BPoMdmmlLhQRFdSKK3VTEC8oIoqaTKYT27S5I5nmMp8kVqhQ8IPD+RfnnN9K0hTlfbby5u77k9anQUie5yg1RLoCTw2ZBgFBGBInCWEUEcUxRTFrpbXGiuME2xHYjottC4SQjMY+H7ZDkn1xutejs77KwdYGnbUVzve327Jy3gn8EXmu6R9uctHv0WAJV/Ly+oYrFY6QaD1jkcebASe7XS7Pjjje6XI3uCJNUzwpmPhjsizj4f6a56fbn8GyLCmKksarqsIY80fLaLK1MVRV3XZ+aW5rWWFxzNT1v0/qeaYZ/AYe8XdvoGZyrQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/aff0aa024d21374a8e2146d6768663c9/a59e9/remove-enabled.webp 192w,\n/static/aff0aa024d21374a8e2146d6768663c9/0ca9f/remove-enabled.webp 384w,\n/static/aff0aa024d21374a8e2146d6768663c9/83502/remove-enabled.webp 764w\"\n              sizes=\"(max-width: 764px) 100vw, 764px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/aff0aa024d21374a8e2146d6768663c9/3b721/remove-enabled.png 192w,\n/static/aff0aa024d21374a8e2146d6768663c9/66595/remove-enabled.png 384w,\n/static/aff0aa024d21374a8e2146d6768663c9/2cbcd/remove-enabled.png 764w\"\n            sizes=\"(max-width: 764px) 100vw, 764px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/aff0aa024d21374a8e2146d6768663c9/2cbcd/remove-enabled.png\"\n            alt=\"점심시간이 끝나가서 급하게 fallback을 적었다...🥲\"\n            title=\"점심시간이 끝나가서 급하게 fallback을 적었다...🥲\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">점심시간이 끝나가서 급하게 fallback을 적었다...🥲</figcaption>\n  </figure></p>\n<p>확인결과 enabled 때문에 useQuery가 돌지 않았던 게 맞았다.</p>\n<br>","tableOfContents":"<ul>\n<li><a href=\"#%EA%B5%AC%EC%84%B1%EC%9A%94%EC%86%8C\">구성요소</a></li>\n<li><a href=\"#%EC%9B%90%ED%95%98%EB%8A%94-%EB%8F%99%EC%9E%91\">원하는 동작</a></li>\n<li><a href=\"#%EC%9B%90%EC%9D%B8%ED%8C%8C%EC%95%85-%EC%A4%91\">원인파악 중</a></li>\n<li><a href=\"#network-tab-%ED%99%95%EC%9D%B8%ED%95%98%EA%B8%B0\">Network tab 확인하기</a></li>\n<li><a href=\"#%EC%84%9C%EB%B2%84-%EC%BB%B4%ED%8F%AC%EB%84%8C%ED%8A%B8%EB%8A%94\">서버 컴포넌트는?</a></li>\n<li><a href=\"#%EA%B2%B0%EB%A1%A0\">결론</a></li>\n<li><a href=\"#%EB%B2%88%EC%99%B8\">번외</a></li>\n</ul>","frontmatter":{"title":"next.js에서 useQuery + Suspense를 사용했을 때 fallback ui가 보이지 않는다 -1","summary":"react에선 새로고침할 때마다 fallback ui를 잘 보여주는데...","date":"2023.10.03.","categories":["개발"]}}}]}},"pageContext":{"slug":"/blog/2023/10/3/next-js-suspense-usequery/"}},"staticQueryHashes":["1629908903"]}
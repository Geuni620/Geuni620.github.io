{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/2023/6/26/ec2-docker-deploy/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<blockquote>\n<p>새로운 프로젝트를 시작하며, <a href=\"https://geuni620.github.io/blog/2023/6/6/react-deploy-with-docker/\" target=\"_blank\" rel=\"nofollow\">react-deploy-with-docker</a>에서 배포했던 방법에 한 단계 더 나아가서 실제 배포를 진행해봄.</p>\n</blockquote>\n<ul>\n<li>이번 프로젝트에서 목표는 백엔드 / 프론트 / 인프라(간단한) 를 모두 경험해보는 것.</li>\n<li>그래서 일단, next.js로 lint와 tsconfig, prettier 등을 설정한 후, 진행하였음.</li>\n<li>해당 next.js 세팅은 <a href=\"https://github.com/Geuni620/next-boilerplate\" target=\"_blank\" rel=\"nofollow\">여기</a>에 있음.</li>\n</ul>\n<br>\n<h3 id=\"서브-도메인-작성\" style=\"position:relative;\"><a href=\"#%EC%84%9C%EB%B8%8C-%EB%8F%84%EB%A9%94%EC%9D%B8-%EC%9E%91%EC%84%B1\" aria-label=\"서브 도메인 작성 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>서브 도메인 작성</h3>\n<ul>\n<li>AWS Route53에서 서브 도메인을 작성해줌.</li>\n<li>현재 프로덕션으로 돌아가고 있는 사이트의 도메인 <code class=\"language-text\">deep.jejodo.life</code>인데, version.2를 새롭게 기획하고 만들기로 했음.</li>\n<li>그래서 dev.deep.jejodo.life로 서브도메인을 작성함.\n<ul>\n<li><strong>근데 이렇게 서브도메인을 만들면 안되었음. 아래에서 다시 설명할 예정</strong></li>\n</ul>\n</li>\n</ul>\n<br>\n<p>먼저, <code class=\"language-text\">Route 53</code>에 들어감<br>\n그리고, 여기서 오른쪽 상단에 <code class=\"language-text\">레코드 생성</code>을 클릭.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/05617b82a9071db21e9e16d109f35c48/b1317/sub-domain.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 73.95833333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB4ElEQVQ4y42U/ZKbIBTFeeE+Vt+hb9GZnc7+1SSTaPyIooCggMDpADG7SbNpmfmJevFyDhckVTeg7iiKlqKhLFG3LXo6QEwTuBCpf0Ucs0F2hyN+7/bYn84Y+ISRCzDOwa6JPg/+ijhOypycdF2P06lA3bTQWt+xPNw/QxsNtWhUo8IoJEhUQymFMRre+0QIIbE9RxAC4B3gVoQHnLWQaoGaFxApJQbGYV24JXLO5STXFqzBWBZgfQ/NGUxEcBjBYAWHUxJeCuiRgoyMoapbCKkgpcK8LGktos2ULF6MxlAcQZsGQ11jqCvwS4uxqSG6C/yssE4Cc9/lhNMkEbzHurqk7qYsfKjOln22feszYbWAc7DGgExtA348JBXRZLTqrnxeQ/eSAB9CKhJZpIRVEqu18D7cqbpT+ET1Y3xZNIiYJNgkMakZxtisxrm/iMWbF4PVPY/H7+K6E8ZY2szGrljXjLU2reskJeKEap7R9X3aDatzt3Ebzsd3NhWURN/GmOT/lTV81PyuxZg2FtYD2vqccFOltcknw5g0yYb+ghibF422LtAc3iBombdNTynS9pGbzf87w1xwUD6Dlz/R/fgG9vYdpDxX+PX+jt3+gKpuUJRnXLrun3+Ye3JR4+H4A2q9ivdhNs8UAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/05617b82a9071db21e9e16d109f35c48/a59e9/sub-domain.webp 192w,\n/static/05617b82a9071db21e9e16d109f35c48/0ca9f/sub-domain.webp 384w,\n/static/05617b82a9071db21e9e16d109f35c48/dc9b9/sub-domain.webp 768w,\n/static/05617b82a9071db21e9e16d109f35c48/e2c2f/sub-domain.webp 1152w,\n/static/05617b82a9071db21e9e16d109f35c48/f3efb/sub-domain.webp 1536w,\n/static/05617b82a9071db21e9e16d109f35c48/f1645/sub-domain.webp 2256w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/05617b82a9071db21e9e16d109f35c48/3b721/sub-domain.png 192w,\n/static/05617b82a9071db21e9e16d109f35c48/66595/sub-domain.png 384w,\n/static/05617b82a9071db21e9e16d109f35c48/fe486/sub-domain.png 768w,\n/static/05617b82a9071db21e9e16d109f35c48/d2d74/sub-domain.png 1152w,\n/static/05617b82a9071db21e9e16d109f35c48/e8464/sub-domain.png 1536w,\n/static/05617b82a9071db21e9e16d109f35c48/b1317/sub-domain.png 2256w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/05617b82a9071db21e9e16d109f35c48/fe486/sub-domain.png\"\n            alt=\"우리 회사에서 사용하는 도메인은 jejodo.life이다.\"\n            title=\"우리 회사에서 사용하는 도메인은 jejodo.life이다.\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">우리 회사에서 사용하는 도메인은 jejodo.life이다.</figcaption>\n  </figure></p>\n<ul>\n<li>그래서 그 앞에 000.jejodo.life의 000에는 어떠한 단어가 들어가도 됨.</li>\n<li>나는 deep.jejodo.life라는 서브도메인을 만들었기 때문에 이번엔 dev.deep.jejodo.life를 만듦</li>\n</ul>\n<br>\n<h3 id=\"production-dockerfile\" style=\"position:relative;\"><a href=\"#production-dockerfile\" aria-label=\"production dockerfile permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Production Dockerfile</h3>\n<ul>\n<li>dev dockerfile로 작성했었는데, 사실 dev를 작성해서 ec2환경에서 docker container를 띄우는 것보다, production으로 띄우는게 더 나을 것 같다고 생각했음.</li>\n<li>왜냐하면, 같이 일하는 기획자 및 동료분들께 공유하기 위함이기 때문에, 사실 dev의 필요성을 못느낌.\n<ul>\n<li>굳이 dev docker를 띄울 필요가 있을까? prod로 띄우면 되지 않을까? 하는 생각.</li>\n</ul>\n</li>\n</ul>\n<br>\n<ul>\n<li>그래서 다음과 같이 작성해주었음</li>\n<li>이건 같은 동료인 <a href=\"https://github.com/dohyeon2\" target=\"_blank\" rel=\"nofollow\">주도님</a>께서 작성해주신 파일인데, 그 당시엔 옆에서 <code class=\"language-text\">아??? 네???</code> 그러는데 모든게 지나가버림. 그래서 이번엔 하나씩 작성해보면서 시행착오를 겪어보고 싶었음</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre class=\"language-docker\"><code class=\"language-docker\"><span class=\"token comment\"># docker/production.dockerfile</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> node:18.15.0 <span class=\"token keyword\">AS</span> builder</span>\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> package.json .</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> npm i</span>\n\n<span class=\"token comment\"># next.js에서 npm run build 후, 프로덕션을 start하기 위해 필요한 파일을 모두 docker에 복사함</span>\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> node</span>\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">builder</span></span> /app/node_modules ./node_modules</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">builder</span></span> /app/package.json ./package.json</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./next.config.js /app/next.config.js</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./.env.local /app/.env.local</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./.next /app/.next</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./public /app/public</span>\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> npm run start</span></code></pre></div>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token comment\"># docker/production.yml</span>\n<span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.1\"</span>\n\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deep<span class=\"token punctuation\">-</span>jejodo<span class=\"token punctuation\">-</span>life\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">deep-jejodo-life</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> deep<span class=\"token punctuation\">-</span>jejodo<span class=\"token punctuation\">-</span>life\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> .\n      <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> production.dockerfile\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 3040<span class=\"token punctuation\">:</span><span class=\"token number\">3000</span> <span class=\"token comment\"># docker port는 3040으로 열어주었음.</span></code></pre></div>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># docker/production.sh</span>\n<span class=\"token assign-left variable\">BASEDIR</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">dirname</span> $0<span class=\"token variable\">)</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token builtin class-name\">cd</span> <span class=\"token variable\">${BASEDIR}</span> <span class=\"token operator\">&amp;&amp;</span>\n<span class=\"token function\">docker</span> compose <span class=\"token parameter variable\">-f</span> production.yml up --force-recreate <span class=\"token parameter variable\">--build</span> <span class=\"token parameter variable\">-d</span></code></pre></div>\n<ul>\n<li>여기서 초반에 실수를 했는데, <code class=\"language-text\">BASEDIR=${dirname $0}</code>으로 작성했다가 경로를 읽지 못하고 에러가 발생. 알고보니, 중괄호가 아닌 소괄호를 사용해야했음.</li>\n</ul>\n<p><code class=\"language-text\">BASEDIR=${dirname $0}</code> → <code class=\"language-text\">BASEDIR=$(dirname $0)</code></p>\n <br>\n<h3 id=\"ec2에-production\" style=\"position:relative;\"><a href=\"#ec2%EC%97%90-production\" aria-label=\"ec2에 production permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>EC2에 production</h3>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># deploy/package.sh, 다음과 같이 경로를 미리 지정해 준 뒤.</span>\n<span class=\"token assign-left variable\">BASEDIR</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">dirname</span> $0<span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">PROJECT_ROOT</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${BASEDIR}</span>/..\"</span>\n<span class=\"token assign-left variable\">DOCKER_DIR</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${PROJECT_ROOT}</span>/docker\"</span>\n<span class=\"token assign-left variable\">PACKAGE_DIR</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${PROJECT_ROOT}</span>/deploy/package\"</span>\n\n\n<span class=\"token comment\"># build된 파일을 rsync를 통해 EC2에 전송해줌.</span>\n<span class=\"token function\">npm</span> run build <span class=\"token operator\">&amp;&amp;</span>\n<span class=\"token function\">rsync</span> <span class=\"token parameter variable\">-avz</span> <span class=\"token parameter variable\">--delete</span> <span class=\"token variable\">${PROJECT_ROOT}</span>/.next <span class=\"token variable\">${PACKAGE_DIR}</span>/\n<span class=\"token function\">rsync</span> <span class=\"token parameter variable\">-avz</span> <span class=\"token parameter variable\">--delete</span> <span class=\"token variable\">${PROJECT_ROOT}</span>/package.json <span class=\"token variable\">${PACKAGE_DIR}</span>/ <span class=\"token operator\">&amp;&amp;</span>\n<span class=\"token function\">rsync</span> <span class=\"token parameter variable\">-avz</span> <span class=\"token parameter variable\">--delete</span> <span class=\"token variable\">${PROJECT_ROOT}</span>/package-lock.json <span class=\"token variable\">${PACKAGE_DIR}</span>/ <span class=\"token operator\">&amp;&amp;</span>\n<span class=\"token function\">rsync</span> <span class=\"token parameter variable\">-avz</span> <span class=\"token parameter variable\">--delete</span> <span class=\"token variable\">${PROJECT_ROOT}</span>/next.config.js <span class=\"token variable\">${PACKAGE_DIR}</span>/ <span class=\"token operator\">&amp;&amp;</span>\n<span class=\"token function\">rsync</span> <span class=\"token parameter variable\">-avz</span> <span class=\"token parameter variable\">--delete</span> <span class=\"token variable\">${PROJECT_ROOT}</span>/public <span class=\"token variable\">${PACKAGE_DIR}</span>/ <span class=\"token operator\">&amp;&amp;</span>\n<span class=\"token function\">rsync</span> <span class=\"token parameter variable\">-avz</span> <span class=\"token parameter variable\">--delete</span> <span class=\"token variable\">${PROJECT_ROOT}</span>/.env.local <span class=\"token variable\">${PACKAGE_DIR}</span>/ <span class=\"token operator\">&amp;&amp;</span>\n\n<span class=\"token function\">rsync</span> <span class=\"token parameter variable\">-avz</span> <span class=\"token parameter variable\">--delete</span> <span class=\"token variable\">${DOCKER_DIR}</span>/production.yml <span class=\"token variable\">${PACKAGE_DIR}</span>/ <span class=\"token operator\">&amp;&amp;</span>\n<span class=\"token function\">rsync</span> <span class=\"token parameter variable\">-avz</span> <span class=\"token parameter variable\">--delete</span> <span class=\"token variable\">${DOCKER_DIR}</span>/production.dockerfile <span class=\"token variable\">${PACKAGE_DIR}</span>/ <span class=\"token operator\">&amp;&amp;</span>\n<span class=\"token function\">rsync</span> <span class=\"token parameter variable\">-avz</span> <span class=\"token parameter variable\">--delete</span> <span class=\"token variable\">${DOCKER_DIR}</span>/production.sh <span class=\"token variable\">${PACKAGE_DIR}</span>/ <span class=\"token operator\">&amp;&amp;</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"packaging done\"</span></code></pre></div>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># deploy/deploy.sh, 여기선 내 pem파일을 통해 EC2에 접속한 뒤, 해당 경로로 이동하여 production.sh를 실행시켜줌.</span>\n<span class=\"token function\">rsync</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"ssh -i ~/.ssh/geuni.pem\"</span> <span class=\"token parameter variable\">-avz</span> <span class=\"token parameter variable\">--delete</span> deploy/package/ 경로지정<span class=\"token punctuation\">(</span>ex test@1.12.123.123:deep.jejodo.life<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n<span class=\"token function\">ssh</span> <span class=\"token parameter variable\">-i</span> pem_key <span class=\"token string\">\"cd deep-jejodo-life &amp;&amp; sudo -S sh production.sh\"</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"deploy done\"</span></code></pre></div>\n<ul>\n<li>이렇게 하면 EC2에 복사된 파일이 잘 정착하고, Docker를 통해 Production 파일이 컨테이너로 띄워진다.</li>\n<li>위에서 작성해놓았듯,<br>\n브라우저 → <code class=\"language-text\">dev.deep.jejodo.life</code>로 접속<br>\n→ 로드밸런싱을 통해 apache가 80번 포트로 해당 요청을 받는다.<br>\n→ apache는 3040번 포트로 요청을 보내고<br>\n→ docker는 3040번 포트로 요청을 받아서<br>\n→ next.js가 3000번 포트로 요청을 받는다. 그리고 다시 역으로 돌아가서 → 브라우저로 응답을 보내준다.</li>\n</ul>\n<br>\n<h3 id=\"ec2에-apache-세팅하기\" style=\"position:relative;\"><a href=\"#ec2%EC%97%90-apache-%EC%84%B8%ED%8C%85%ED%95%98%EA%B8%B0\" aria-label=\"ec2에 apache 세팅하기 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>EC2에 Apache 세팅하기</h3>\n<br>\n<ul>\n<li>우리 회사 기준으로 Apache config는 etc에 있었다</li>\n<li>etc/apache2/sites-enabled/000-geuni.conf</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"apache\"><pre class=\"language-apache\"><code class=\"language-apache\"># 기존에 사용하던 deep.jejodo.life 도메인으로 연결됨\n&lt;VirtualHost *:80&gt;\n  ServerName deep.jejodo.life\n  ServerAdmin joo@jaminlife.me\n\n        ProxyRequests Off\n        ProxyPreserveHost On\n        ProxyVia Full\n\n        &lt;Proxy /*&gt;\n    Allow from all\n                Require all granted\n        &lt;/Proxy&gt;\n\n        ProxyPass / http://127.0.0.1:3020/\n        ProxyPassReverse / http://127.0.0.1:3020/\n&lt;/VirtualHost&gt;\n\n# devdeep.jejodo.life 도메인으로 접속시 연결됨\n&lt;VirtualHost *:80&gt;\n  ServerName devdeep.jejodo.life\n  ServerAdmin lkh@jaminlife.me\n\n        ProxyRequests Off\n        ProxyPreserveHost On\n        ProxyVia Full\n\n        &lt;Proxy /*&gt;\n    Allow from all\n                Require all granted\n        &lt;/Proxy&gt;\n\n        ProxyPass / http://127.0.0.1:3040/\n        ProxyPassReverse / http://127.0.0.1:3040/\n&lt;/VirtualHost&gt;</code></pre></div>\n<ul>\n<li>아파치는 80번 포트로 요청을 받는데, 여기서 3040번 포트를 어떻게 바라 볼 수 있을까?\n<ul>\n<li>이건 sub-domain의 이름으로 구분지을 수 있었다</li>\n<li>즉, dev.deep.jejodo.life로 domain을 지정해놓으면, 이 도메인으로 요청을 받아서 해당하는 3040번 포트에 파일을 다시 전달해주는 것.</li>\n<li>다르게는, deep.jejodo.life로 domain을 지정해놓으면, 이 도메인으로 요청을 받아서 해당하는 3020번 포트에 파일을 다시 전달해주는 것.</li>\n<li>이렇게해서 인스턴스 하나에 아파치를 통해 포트번호만 다르게 지정해주면 해당 파일을 전달해줄 수 있다.</li>\n</ul>\n</li>\n</ul>\n<br>\n<ul>\n<li>이제 아파치를 재시작해 준다</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># 아파치 서버 재시작</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">service</span> apache2 restart\n\n<span class=\"token comment\"># 아파치 서버 재시작 한지 status로 확인</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">service</span> apache2 status</code></pre></div>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/20af12e9b39ed2afa5f59b7980d144ab/9c259/apache_restart.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 11.979166666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAh0lEQVQI1z3MuwrCQBBAUeuouwGTiaDJTFgxD9cgAYOtYuM/WNpY+/9cC8HqdGfmb0+Sx4f5/c3i+sKFM95OZDYgNpDrERFF8hKR6mehFHlJJoorarwofr3DZyWzNHG4MpJqi3R7VnFgO400/UgVRqyZ0PaC1RHTA2YR1Z6gHWETWEpNKvYPv6DUN2PxalADAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/20af12e9b39ed2afa5f59b7980d144ab/a59e9/apache_restart.webp 192w,\n/static/20af12e9b39ed2afa5f59b7980d144ab/0ca9f/apache_restart.webp 384w,\n/static/20af12e9b39ed2afa5f59b7980d144ab/dc9b9/apache_restart.webp 768w,\n/static/20af12e9b39ed2afa5f59b7980d144ab/e2c2f/apache_restart.webp 1152w,\n/static/20af12e9b39ed2afa5f59b7980d144ab/fcda8/apache_restart.webp 1272w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/20af12e9b39ed2afa5f59b7980d144ab/3b721/apache_restart.png 192w,\n/static/20af12e9b39ed2afa5f59b7980d144ab/66595/apache_restart.png 384w,\n/static/20af12e9b39ed2afa5f59b7980d144ab/fe486/apache_restart.png 768w,\n/static/20af12e9b39ed2afa5f59b7980d144ab/d2d74/apache_restart.png 1152w,\n/static/20af12e9b39ed2afa5f59b7980d144ab/9c259/apache_restart.png 1272w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/20af12e9b39ed2afa5f59b7980d144ab/fe486/apache_restart.png\"\n            alt=\"apache-restart\"\n            title=\"apache-restart\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">apache-restart</figcaption>\n  </figure></p>\n<br>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 557px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f3bb7855f4b7b9b9159e1bc954af615b/5b443/deep.jejodo.life.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.3125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA20lEQVQY0zWM22rDMBQE/f+/lcdSmuDQpBgSOZfGsnR0s3yJX6ZEbQ8snBmWrUwXeN26rozjyJgz47SgrppDo2hOd5rTjVP7wIYZn1b8sCJxwaXnL6dn+V+u6r4d0zyWsWmZcUMk55EQBnoT0b1wufe0N40PQ4mVQM4LKU6Ijzifih/yTLX9OHBWZ5RqUdcrXxdF27boXhNDJqZIZyy3h8Z7hzhHbwwxJZzzWLGIE6xIcdVm88ZuX/O+3bHb7/k8HtnWNcemobOmjPUiGHFoa9FWCnfG0P3xf17dH+TmK54dLOtRAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f3bb7855f4b7b9b9159e1bc954af615b/a59e9/deep.jejodo.life.webp 192w,\n/static/f3bb7855f4b7b9b9159e1bc954af615b/0ca9f/deep.jejodo.life.webp 384w,\n/static/f3bb7855f4b7b9b9159e1bc954af615b/81687/deep.jejodo.life.webp 557w\"\n              sizes=\"(max-width: 557px) 100vw, 557px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f3bb7855f4b7b9b9159e1bc954af615b/3b721/deep.jejodo.life.png 192w,\n/static/f3bb7855f4b7b9b9159e1bc954af615b/66595/deep.jejodo.life.png 384w,\n/static/f3bb7855f4b7b9b9159e1bc954af615b/5b443/deep.jejodo.life.png 557w\"\n            sizes=\"(max-width: 557px) 100vw, 557px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f3bb7855f4b7b9b9159e1bc954af615b/5b443/deep.jejodo.life.png\"\n            alt=\"url을 한번 확인해보자\"\n            title=\"url을 한번 확인해보자\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">url을 한번 확인해보자</figcaption>\n  </figure></p>\n<ul>\n<li>위에서 언급했듯이, <code class=\"language-text\">dev.deep.jejodo.life</code>로 지정해둔 도메인을 <code class=\"language-text\">devdeep.jejodo.life</code>로 변경해주었다.</li>\n<li>왜냐하면, dev.deep.jejodo.life로 지정해줬을 경우 https 인증서를 따로 발급해야했기 때문</li>\n<li>하지만 devdeep.<code class=\"language-text\">jejodo.life</code>로 지정해줬을 경우 <code class=\"language-text\">jejodo.life 인증서</code> 는 발급받아놓았기 때문에 따로 다시 발급받을 필요는 없었음.</li>\n</ul>","tableOfContents":"<ul>\n<li><a href=\"#%EC%84%9C%EB%B8%8C-%EB%8F%84%EB%A9%94%EC%9D%B8-%EC%9E%91%EC%84%B1\">서브 도메인 작성</a></li>\n<li><a href=\"#production-dockerfile\">Production Dockerfile</a></li>\n<li><a href=\"#ec2%EC%97%90-production\">EC2에 production</a></li>\n<li><a href=\"#ec2%EC%97%90-apache-%EC%84%B8%ED%8C%85%ED%95%98%EA%B8%B0\">EC2에 Apache 세팅하기</a></li>\n</ul>","frontmatter":{"title":"ec2-docker-deploy","summary":"-","date":"2023.06.26.","categories":["개발"]}}}]}},"pageContext":{"slug":"/blog/2023/6/26/ec2-docker-deploy/"}},"staticQueryHashes":["1629908903"]}
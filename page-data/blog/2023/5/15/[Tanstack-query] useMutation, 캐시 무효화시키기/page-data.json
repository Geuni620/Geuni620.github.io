{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/2023/5/15/[Tanstack-query] useMutation, 캐시 무효화시키기/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h3 id=\"usemutation-캐시-무효화시키기\" style=\"position:relative;\"><a href=\"#usemutation-%EC%BA%90%EC%8B%9C-%EB%AC%B4%ED%9A%A8%ED%99%94%EC%8B%9C%ED%82%A4%EA%B8%B0\" aria-label=\"usemutation 캐시 무효화시키기 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>useMutation, 캐시 무효화시키기</h3>\n<blockquote>\n<p>useMutation으로 photo Delete 구현 중 캐시가 업데이트에 문제가 생김</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> useDeletePhotoListQuery <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UseMutateFunction<span class=\"token operator\">&lt;</span>\n  <span class=\"token keyword\">void</span><span class=\"token punctuation\">,</span>\n  <span class=\"token builtin\">unknown</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> selectedPhotoIds<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token builtin\">unknown</span>\n<span class=\"token operator\">></span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> queryClient <span class=\"token operator\">=</span> <span class=\"token function\">useQueryClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> mutate <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useMutation</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> selectedPhotoIds <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> selectedPhotoIds<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n      <span class=\"token function\">deletePhotoList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> selectedPhotoIds <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token function-variable function\">onSuccess</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>newData<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// queryClient.setQueriesData([queryKeys.photoList], newData); // 자동으로 업데이트 되긴 함.</span>\n        queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">invalidateQueries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>queryKeys<span class=\"token punctuation\">.</span>photoList<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 수동으로 트리거 시켜주어야 캐시가 업데이트 됨.</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> mutate<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\n<p>2번 photo를 삭제했으나,\n<figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cb6c79d6b65e939be346b84d6e7576ef/d98b8/delete.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.22916666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABdklEQVQoz5XR24vUMBTH8f7zPgmLr/4Zoqjgiy+CuLoOO8ve5tp0bp0kbZNeJ23zlYmIr7MHPvwSDhw4nKhpO7qT45x104a0RUlVNzR1jVUSoyRWq5B5mmKVwkgZeqEvJeZ4pFCKaLs7sE+PFMZSN00YdM7aDdTP96jr76S3E9TtDdndBD395zf5wx3Zw5Rm+YzbxnS/vhHN5gvmyxVlVdH3Pc453OmE8zDEM4qnGBUfKBKBSQSFEOTxmmq/o8yzoMoz2u6Em/4kikWC1hlt24WBgXP03uPSHX41w2/WjJsVQ7JkEH+Fv1gwxAv69Zz+/F48EiXbHctVjFQaW1YYazG2pDCG1vV4XlbRRqwpjaarDbXNaKuCpsxpyozh1OLHEfyIv8Q4En29WXP9mPLjSTMVDffbLpgmHUJ2gMf7y0Vv3gvefkl5/eFMcvVRc/VJ8eqd5PPEhjX8C/aO9HGLLSQ2Tyn0ntpIbHbA6B2VzeiH4f+xLvAHqKasuCUyy3gAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/cb6c79d6b65e939be346b84d6e7576ef/a59e9/delete.webp 192w,\n/static/cb6c79d6b65e939be346b84d6e7576ef/0ca9f/delete.webp 384w,\n/static/cb6c79d6b65e939be346b84d6e7576ef/dc9b9/delete.webp 768w,\n/static/cb6c79d6b65e939be346b84d6e7576ef/e2c2f/delete.webp 1152w,\n/static/cb6c79d6b65e939be346b84d6e7576ef/f3efb/delete.webp 1536w,\n/static/cb6c79d6b65e939be346b84d6e7576ef/87c42/delete.webp 1588w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/cb6c79d6b65e939be346b84d6e7576ef/3b721/delete.png 192w,\n/static/cb6c79d6b65e939be346b84d6e7576ef/66595/delete.png 384w,\n/static/cb6c79d6b65e939be346b84d6e7576ef/fe486/delete.png 768w,\n/static/cb6c79d6b65e939be346b84d6e7576ef/d2d74/delete.png 1152w,\n/static/cb6c79d6b65e939be346b84d6e7576ef/e8464/delete.png 1536w,\n/static/cb6c79d6b65e939be346b84d6e7576ef/d98b8/delete.png 1588w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/cb6c79d6b65e939be346b84d6e7576ef/fe486/delete.png\"\n            alt=\"2번 photo를 delete\"\n            title=\"2번 photo를 delete\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">2번 photo를 delete</figcaption>\n  </figure></p>\n<br>\n<p>delete 이후 데이터를 가져오면 캐시 무효화가 되지 않았음.\n<figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ebc032595dd6add9867169d1b9475045/d98b8/get.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.22916666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABaUlEQVQoz5WRW2/TQBCF/fN5gRdA/AzeuKgpl5aKmygqBQkpiZtknTi+xt5d73q92B+y1YdKFKkd6dPZh9HMmbOBsS2t6xi1MXZSWSm0NhhjkIeSuiyo8hxZltRFgTocqKVE6QatG2qp6DpP5z3BdrcnTlKqWtIYg27MpKZ1qIuvJO/fkHw6I/38gf3HE8TZO5KTGfmPc6IkQ4iIjYiItju2u5hgvliyCK9QWuO9p+s6OuembZ1Y0S7muPUV7SbErBbYdYhd/sZne4xzNFqjtUYphZKKYL0RFEWJte008CauH7hvBaPVcLUmH7PRGinVxJhRay1D39/OMNxKMF+uSLOSvKxIsoIsP5Dm5fRuGjttHX2OzXdyGIsQXSUMTgIe6G/g6a/P/p+jfxw+e73jwXPBoxc5j48qnsxqns5qHr6qmP1srofdI8PTy5jTXynH37ccfRO8vYg5Po94+WXDZZgz9H+mH/d35C84fq/7gv09IwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/ebc032595dd6add9867169d1b9475045/a59e9/get.webp 192w,\n/static/ebc032595dd6add9867169d1b9475045/0ca9f/get.webp 384w,\n/static/ebc032595dd6add9867169d1b9475045/dc9b9/get.webp 768w,\n/static/ebc032595dd6add9867169d1b9475045/e2c2f/get.webp 1152w,\n/static/ebc032595dd6add9867169d1b9475045/f3efb/get.webp 1536w,\n/static/ebc032595dd6add9867169d1b9475045/87c42/get.webp 1588w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/ebc032595dd6add9867169d1b9475045/3b721/get.png 192w,\n/static/ebc032595dd6add9867169d1b9475045/66595/get.png 384w,\n/static/ebc032595dd6add9867169d1b9475045/fe486/get.png 768w,\n/static/ebc032595dd6add9867169d1b9475045/d2d74/get.png 1152w,\n/static/ebc032595dd6add9867169d1b9475045/e8464/get.png 1536w,\n/static/ebc032595dd6add9867169d1b9475045/d98b8/get.png 1588w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/ebc032595dd6add9867169d1b9475045/fe486/get.png\"\n            alt=\"delete 이후 get해온 데이터\"\n            title=\"delete 이후 get해온 데이터\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">delete 이후 get해온 데이터</figcaption>\n  </figure></p>\n<ul>\n<li>invalidateQueries가 정상적으로 동작하지 않음\n<ul>\n<li>photoData를 delete하는 버튼을 클릭하고 난 이후, invalidateQueries가 re-fetch 트리거를 거는 걸로 알고 있는데,\n<ol>\n<li>refetch 되지만, 기존 50개의 데이터를 그대로 가져옴</li>\n<li>refetch 되지 않고, 수동으로 트리거를(refetchOnWindow) 걸어주면 50개에서 49개로 변경 됨.</li>\n</ol>\n</li>\n</ul>\n</li>\n</ul>\n<br>\n<h3 id=\"해결과정\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0%EA%B3%BC%EC%A0%95\" aria-label=\"해결과정 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결과정</h3>\n<blockquote>\n<p>프론트 코드에는 이상 없었음.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> NextApiRequest<span class=\"token punctuation\">,</span> NextApiResponse <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> fs <span class=\"token keyword\">from</span> <span class=\"token string\">'fs'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// import photoList from 'pages/api/photo/photo.json';</span>\n<span class=\"token keyword\">const</span> photoList<span class=\"token operator\">:</span> Photo<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'pages/api/photo/photo.json'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>req<span class=\"token operator\">:</span> NextApiRequest<span class=\"token punctuation\">,</span> res<span class=\"token operator\">:</span> NextApiResponse<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>method <span class=\"token operator\">===</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> photo<span class=\"token operator\">:</span> photoList <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>method <span class=\"token operator\">===</span> <span class=\"token string\">'DELETE'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> ids <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>ids <span class=\"token keyword\">as</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">','</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> photoList<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token operator\">!</span>ids<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token function\">String</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      fs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'pages/api/photo/photo.json'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        ids<span class=\"token operator\">:</span> ids<span class=\"token punctuation\">,</span>\n        message<span class=\"token operator\">:</span> <span class=\"token string\">'Photos deleted successfully'</span><span class=\"token punctuation\">,</span>\n        photo<span class=\"token operator\">:</span> result<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> error<span class=\"token operator\">:</span> err <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>DB를 import로 불러오면 파일이 불러올 때만 데이터가 업데이트 됨</li>\n<li>하지만 fe.readFileSync()로 불러오면 API endpoint가 호출될 때마다 최신 버전의 photo.json 파일이 로드 됨</li>\n<li>하지만 import로 불러오면 파일에서 가져온 기본값을 사용하므로, photoList 데이터가 한 번 로드되고 서버가 다시 시작될 때까지 다시 업데이트 되지 않음.</li>\n</ul>\n<br>","tableOfContents":"<ul>\n<li><a href=\"#usemutation-%EC%BA%90%EC%8B%9C-%EB%AC%B4%ED%9A%A8%ED%99%94%EC%8B%9C%ED%82%A4%EA%B8%B0\">useMutation, 캐시 무효화시키기</a></li>\n<li><a href=\"#%ED%95%B4%EA%B2%B0%EA%B3%BC%EC%A0%95\">해결과정</a></li>\n</ul>","frontmatter":{"title":"[Tanstack-query] useMutation, 캐시 무효화시키기","summary":"-","date":"2023.05.15.","categories":["개발"]}}}]}},"pageContext":{"slug":"/blog/2023/5/15/[Tanstack-query] useMutation, 캐시 무효화시키기/"}},"staticQueryHashes":["1629908903"]}
{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/2023/8/11/trouble-shooting/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<blockquote>\n<p>요번 주에 <a href=\"https://deep.jejodo.life/\" target=\"_blank\" rel=\"nofollow\">제조도 블로그</a>를 만들면서 오랫동안 해결하지 못했던 문제를 해결했다.<br>\n제조도 블로그의 사용자 데이터는 google analytics로 쌓고 있는데, 시리님께서 조회수기능이 필요하다고 말씀해주셨고, 기록을 보니 5월 4일이었다.<br>\n제조도 블로그는 5월 1일부터 시작했는데, 4일 회의 때 조회수기능이 필요하다는 말씀을 하셨고, PR을 확인해보니 16일에 기능을 merge 했다.<br>\n그리고 현재 8월 11일, 그 동안 여러 이슈들이 존재했는데, 조회수 기능이 revalidate time을 적용시켜놓아도 적용되지 않는 이슈가 있었다.<br>\nNotion / Youtube / Insta까지 revalidate Time이 모두 잘 적용되는데도 불구하고, google analytics의 조회수 기능만 적용되지 않았다.\n그래서 매번 re-deploy를 해주어야했다. 오늘 명확히 이 문제를 해결할 수 있었다.</p>\n</blockquote>\n<br>\n<p>사실 다른 크리티컬한 이슈들이 많이 존재하기도 했고 version.2를 준비하고 있어서 신경쓰지 못했던 것도 있다. 당시엔 어드민 페이지도 작업하고 있었기데, 더 늦어지게 됐다. 그래도 기다려준 시리님께 정-말 감사하다.</p>\n<p>어떻게 접근했는지 하나하나 기록으로 남겨보려 한다.</p>\n<h3 id=\"revalidate-time이-적용되지-않는다\" style=\"position:relative;\"><a href=\"#revalidate-time%EC%9D%B4-%EC%A0%81%EC%9A%A9%EB%90%98%EC%A7%80-%EC%95%8A%EB%8A%94%EB%8B%A4\" aria-label=\"revalidate time이 적용되지 않는다 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>revalidate time이 적용되지 않는다.</h3>\n<p>현재 제조도 블로그는 app 디렉토리를 사용했다. app 디렉토리에선 fetch함수 내 revalidate 타입을 지정해 줄 수 있는데, 이 revalidate time을 지정해주면 일정 시간 후 re-generate 하게 된다. 근데, re-generate 하게 되면, 당연히 데이터로 refresh 되어야하는데, 이게 적용되지 않았다.<br>\n그래서 조회수를 업데이트하기 위해선 re-deploy 해주어야했다.</p>\n<br>\n<h3 id=\"nextjs의-자체-오류인걸까\" style=\"position:relative;\"><a href=\"#nextjs%EC%9D%98-%EC%9E%90%EC%B2%B4-%EC%98%A4%EB%A5%98%EC%9D%B8%EA%B1%B8%EA%B9%8C\" aria-label=\"nextjs의 자체 오류인걸까 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>next.js의 자체 오류인걸까?</h3>\n<p>이 생각을 했던 이유가, app 디렉토리를 사용해서 개발할 당시엔 stable 단계가 아니었다. 그래서 사실 stable 단계가 되었을 때도 무슨 이슈가 발생하면 next.js github issue 탭부터 확인했다. 우연히 유튜브 알고리즘을 통해 <a href=\"https://youtu.be/25yjSzl6PsQ\" target=\"_blank\" rel=\"nofollow\">이 영상</a>을 확인하게 되었는데, 더욱 의심을 가지게 되었다.</p>\n<p>또한 Delete route handler가 적용되지 않는 <a href=\"https://github.com/vercel/next.js/issues/48096\" target=\"_blank\" rel=\"nofollow\">이슈</a>도 확인했던 터라 의심의 의심을 불러일으켰다.\n잘못 선택한 걸까… 그냥 page 디렉토리로 갔어야했나, 하는 생각도 들었다.</p>\n<br>\n<h3 id=\"그래도-해결해야한다\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%9E%98%EB%8F%84-%ED%95%B4%EA%B2%B0%ED%95%B4%EC%95%BC%ED%95%9C%EB%8B%A4\" aria-label=\"그래도 해결해야한다 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그래도 해결해야한다.</h3>\n<p>손놓고 있을 순 없지않나, 해결방법을 고민했다. revalidate-time이 적용되지 않는다면, 그냥 client로 넘겨버리면 되지 않을까? 하는 생각이 들었다.\n그래서 구글 애널리틱스 코드를 서버컴포넌트에서 클라이언트 컴포넌트로 변경했다. <code class=\"language-text\">react-query</code>까지 설정하고, 보일러플레이트 작성하기 보단, <code class=\"language-text\">useEffect</code>를 통해서 구현했다.(후엔 변경하게 되었지만.)\n<a href=\"https://github.com/dohyeon2\" target=\"_blank\" rel=\"nofollow\">주도님</a>께서 리뷰를 남겨주셨는데, useEffect로 fetch하는 코드를 보시곤, useQuery쓰는게 더 낫지 않냐는 말씀을 하셨는데, 당시엔 version.2를 만들생각을 하고 있었고, ‘그 정도 품을 들일 필요 있나 다시 만들게 될텐데..’ 하는 <strong>안일한 생각을 했다.</strong></p>\n<ul>\n<li>이때 하나 크게 배우게 되었는데, 프로덕트 중 특히, 내가 맡고 있는 주인의식을 가지고 있는 프로덕트에 품이 든다는 생각으로 안일하게 대처하면 <strong>오히려 더 큰 문제가 생기거나 시간이 걸린다는 사실을 알게되었다.</strong></li>\n<li>그래도 당시엔, react-query의 보일러플레이트 작성하는 것보다, useEffect로 빠르게 조회수기능만 정상화 시킨 상태에서 version.2에 더 시간을 쓰려고 했던 마음도 있었다.</li>\n<li>이러나 저라나 나에겐 모두 깨달음을 얻게 해주었다. <strong>결국 상황을 읽고 옳은 판단을 해야 리소스도 줄일 수 있고, 줄인 리소스를 더 나은 곳에 쓸 수 있다는 것이다.</strong> 왜냐하면 시간은 항상 한정되어 있으니.</li>\n</ul>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>isClient<span class=\"token punctuation\">,</span> setIsClient<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>filteredView<span class=\"token punctuation\">,</span> setFilteredView<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useState</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>ViewProps<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setIsClient</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>\n          <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NEXT_PUBLIC_ORIGIN</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/api/google/views</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> postView <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>view<span class=\"token operator\">:</span> ViewProps<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> view<span class=\"token punctuation\">.</span>title <span class=\"token operator\">===</span> title<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">setFilteredView</span><span class=\"token punctuation\">(</span>postView<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>\n          <span class=\"token string\">'포스트의 조회수를 가져오는 과정에서 에러가 발생했어요.'</span><span class=\"token punctuation\">,</span>\n          error<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\n<p>역시 위 코드는 적용되지 않았다. 그래서 이상하다는 생각을 했는데, refresh 자체가 되지 않는 것 같았다.<br>\n당시엔 ISG / SSR / SSG / CSR의 개념에 대해 명확히 이해하고 있지 못했다. 특히 데이터 fetch 해오는 과정을 말이다.\n그래서 테스트를 해봐야겠다는 생각이 들어 4개의 보일러플레이트를 각각 만들고, build를 각각 해보았다. 서버는 간단히 express로 구현했다.\n해당 내용은 <a href=\"https://geuni620.github.io/blog/2023/8/3/next-build-type/\" target=\"_blank\" rel=\"nofollow\">여기</a>서 확인할 수 있다.</p>\n<br>\n<p>테스트를 통해 명확히 알게 되었다. 데이터를 가져올 때 SSG는 refresh 되지 않는다는 사실을. 하지만, 이때까지만 해도 근본적인 원인은 모르고 있었다.\n그러다가, 잘 돌아가던 댓글기능이 한번 오류가 발생한 적이 있었는데, 이 과정에서 npm run build로 로컬에서 build후 dev로 띄워보았다.\n이때 이걸 보게 되었다.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6e2618c8756cfff8a0b88c003c9f26ff/6648e/static-img.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.70833333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAACLklEQVQ4y22U6VLicBDEeRZlFby4E0JCDkLuEwICIquWte//CL3VoxGz7oepyT816cz8epKWFeXQ3AjDuYvL3gS/BiquhtOvzGj3FdyqBqy4wK1iYGL7mLoh7DSH5oWN+pbuJ7DjAooTyI3uePZDlIJ3UxN+sYFfbnE90nCj6oj2CbwqwPXom6Di+PCKDZLNAV5eYZlX6HwT/RJU59C9GKyvX6bZBuzQbgrqXoJ8/4xFupIx2PHDzGqMT8F7zYSTrNAd63LujDVo4QLO+p8ODT8FOTLMMEOwepTrgbFAd6KLMONuamAehxg51leH3YmGgWU2GWrLCFG1R7TeIa72yHdHpNsnrI8vgoGG3SjGhylJhkVWCEMKMC57SoN5i1xWT7+R754lU2xzekP1/IrHl3dkj0cYQSoYwtUOnKgWqxk3OryfmlBsX4DPvFg4zpYx1EUgZ+aebktXw/lC4myWinZPxdXgLNpys7W4S37tgYqLhzEuPrkxaAAzR2YtuY4tT168LEuYSdzscB6ksoeqE2BkulLI1RiZS1kVFnVGGm5VHW6ZQfXOHfZN86cphp+g3J9Q7E8oDyfhd3j7I1EdX8X1emy/rGDGnwyH6ufISoNli8Xc/nC9kwXnWHQ33R6QbA9iEpn2dUd2lV9Ubcr/osXCeZiBoztJKZlnGmJFhSz62PoYnyjYQHcyk6+JQaZ1lg4pyF2k2+TGaz7I+zVPOkshmsEfQ33NqOuZ+R/4C9FT3ZmQEt86AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/6e2618c8756cfff8a0b88c003c9f26ff/a59e9/static-img.webp 192w,\n/static/6e2618c8756cfff8a0b88c003c9f26ff/0ca9f/static-img.webp 384w,\n/static/6e2618c8756cfff8a0b88c003c9f26ff/dc9b9/static-img.webp 768w,\n/static/6e2618c8756cfff8a0b88c003c9f26ff/1dd27/static-img.webp 948w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/6e2618c8756cfff8a0b88c003c9f26ff/3b721/static-img.png 192w,\n/static/6e2618c8756cfff8a0b88c003c9f26ff/66595/static-img.png 384w,\n/static/6e2618c8756cfff8a0b88c003c9f26ff/fe486/static-img.png 768w,\n/static/6e2618c8756cfff8a0b88c003c9f26ff/6648e/static-img.png 948w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/6e2618c8756cfff8a0b88c003c9f26ff/fe486/static-img.png\"\n            alt=\"Static\"\n            title=\"Static\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Static</figcaption>\n  </figure></p>\n<blockquote>\n<p>○ (Static) automatically rendered as static HTML (uses no initial props)</p>\n</blockquote>\n<p>○ 이 표시는 Static하게 build 되었다는 의미인데, api 폴더 내에 google/views까지 static하게 build 되어있었다.<br>\n그래서, 이것만 동적으로 풀어주면 되지 않을까? 하는 생각이 들어, 다음과 같이 수정해주었다.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5a3ca8550d46e4c4861ad17c3181b593/0c7a1/server-img.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 63.541666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAACNklEQVQ4y22T61LbMBCF8yhtHAgpwbJjx/ebfJcdx7mQQICmQ2dop+//AKezgsC05MfOrqSdz3uO5IFbNDCTEmPTg6LZuJg5uJydsoORZsHiJZifQPM5rKSEXzVyTWeXb32nGMS5AC8bMMvHdGbjavYBPQHdTKDe7PHNCqB6Iep9A6fgGKpngC+Bgz9Vjt9pjOckxK85g66ZUGbuO9BOK/hliwvdwdiwwRuaNMSQnQEe4xBPKcdDHOIhiXFwLVwzE0PtY0KveJWosDnGpotgkcPgMZRzE0ZNj7y/Rdpt0O0fUWzuEFQdzCjHhW5DYRasNEO8ELgyXYw0G5O5K2s6/wRMRI/N4w/0908yrw9HHJ5fsPv+E3m3AfMS+EUrPRwbr5BTEOB/6GCeFMi6DcrVDulijXy5RbXeoVrv5f6NE8GIcgRl+w4YMUtOehYYiyWiusONG+PL1MBQNfH1LYbqXK7dXEgPaVq6IN51MGIu7fgkmaaiIOMJHNadBBhRhqkTyaagFuB9I58SydajCFPXf5/yHyA9h2Z7j2q1k5m8XB2OWN49ScmqG8MrBJKmf5PoSNC5C5FAkkAwsb2TgKK/hdjeyyAvCWjzCkG1wIiZUJgp84jNoain2sSIas3CgH4lL29Al0OynayWQbUZ53Kfeuyshp61YFxAS1uwMIfGBdSkhsoFWNrixuMYkF/0dT1IpZdhtZBAkkhnBKY96nHrHk7ZwamW8MoFwnYNPakwcRNcBxkmdoi/a4O4K7OwYwgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/5a3ca8550d46e4c4861ad17c3181b593/a59e9/server-img.webp 192w,\n/static/5a3ca8550d46e4c4861ad17c3181b593/0ca9f/server-img.webp 384w,\n/static/5a3ca8550d46e4c4861ad17c3181b593/dc9b9/server-img.webp 768w,\n/static/5a3ca8550d46e4c4861ad17c3181b593/e2393/server-img.webp 1090w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/5a3ca8550d46e4c4861ad17c3181b593/3b721/server-img.png 192w,\n/static/5a3ca8550d46e4c4861ad17c3181b593/66595/server-img.png 384w,\n/static/5a3ca8550d46e4c4861ad17c3181b593/fe486/server-img.png 768w,\n/static/5a3ca8550d46e4c4861ad17c3181b593/0c7a1/server-img.png 1090w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/5a3ca8550d46e4c4861ad17c3181b593/fe486/server-img.png\"\n            alt=\"Dynamic\"\n            title=\"Dynamic\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Dynamic</figcaption>\n  </figure></p>\n<blockquote>\n<p>λ (Server) server-side renders at runtime (uses getInitialProps or getServerSideProps)</p>\n</blockquote>\n<p>λ으로 변경해주고 나니, 정상적으로 조회수가 업데이트 되었다.\n물론 중간 과정에 useEffect로 작성했던 fetch코드는 react-query로 변경해준 상태였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useQuery <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@tanstack/react-query'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ViewProps <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'lib/google'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getGoogleViews</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NEXT_PUBLIC_ORIGIN</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/api/google/views</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>res<span class=\"token punctuation\">.</span>ok<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Network response was not ok'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useGoogleViewsGetQuery</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>title<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data<span class=\"token operator\">:</span> post <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'googleViews'</span><span class=\"token punctuation\">,</span> title<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> getGoogleViews<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">select</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>post<span class=\"token operator\">:</span> ViewProps<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> post<span class=\"token punctuation\">.</span>title <span class=\"token operator\">===</span> title<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    post<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위와 같이 변경을 해주니 google analytics의 조회수가 업데이트 될 때마다 refresh한 데이터를 가져온다.</p>\n<p>그래서 시행착오를 다음과 같이 겪었다.</p>\n<ol>\n<li>server-components에서 client-components로 변경</li>\n<li>useEffect → react-query로 변경 cache를 stale하게 만들면 되지 않을까 했다.</li>\n<li>cronTab을 적용해서 일정 시간마다 re-deploy하려고 했다. (시도하진 않았다.)</li>\n<li>결국 dynamic속성을 변경해주었다.</li>\n</ol>\n<br>\n<p>그럼 여기서 의문이 드는게, 왜 처음 revalidate time은 적용되지 않았던 걸까?\n내 생각엔, 이유는 api폴더에 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> dynamic <span class=\"token operator\">=</span> <span class=\"token string\">'force-static'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 이건 이해를 위해 추가해준 것.</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> dynamic <span class=\"token operator\">=</span> <span class=\"token string\">'force-dynamic'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 이렇게 변경해주어야한다.</span>\n\n\n<span class=\"token keyword\">const</span> analyticsDataClient <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BetaAnalyticsDataClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  credentials<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">ANALYTICS_CREDENTIALS</span> <span class=\"token operator\">||</span> <span class=\"token string\">'{}'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token constant\">GET</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>response<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> analyticsDataClient<span class=\"token punctuation\">.</span><span class=\"token function\">runReport</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    property<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">properties/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">ANALYTICS_PROPERTY_ID</span> <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n    dateRanges<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        startDate<span class=\"token operator\">:</span> <span class=\"token string\">'2023-05-01'</span><span class=\"token punctuation\">,</span>\n        endDate<span class=\"token operator\">:</span> <span class=\"token string\">'today'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    dimensions<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        name<span class=\"token operator\">:</span> <span class=\"token string\">'pageTitle'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    metrics<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        name<span class=\"token operator\">:</span> <span class=\"token string\">'screenPageViews'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>rows<span class=\"token operator\">?.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>row<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      title<span class=\"token operator\">:</span> row<span class=\"token punctuation\">.</span>dimensionValues<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">,</span>\n      views<span class=\"token operator\">:</span> row<span class=\"token punctuation\">.</span>metricValues<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NextResponse</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> status<span class=\"token operator\">:</span> <span class=\"token number\">200</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이와 같이 사용하고 있는데, 이게 static으로 묶여버리니, 아무리 api를 요청하는 코드를 revalidate time을 걸거나, cache 타임을 조정하거나, 심지어 useEffect로 요청해봤자, api폴더 자체가 refetch 하지 않으면 소용이 없다.</p>\n<br>\n<p>지금 생각해보니 굳이굳이 api 폴더를 사용할 필요가 있었나 하는 생각도 든다. 그냥 Notion이나, Insta, Youtube처럼 해당 API로 바로 요청을 보내면 되었을 것 같은데, 왜 하필 api폴더를 만들었던 걸까 ㅠㅠ…</p>\n<br>\n<p>어찌됐건 결국 문제를 해결할 수 있었다. 블로그 내 다른 이슈들도 몇 가지 존재하고, docker내 에러들도 뜨는게 있는데, 차근차근 이슈를 줄여나가야겠다.</p>\n<br>\n<h3 id=\"번외\" style=\"position:relative;\"><a href=\"#%EB%B2%88%EC%99%B8\" aria-label=\"번외 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>번외</h3>\n<p><a href=\"https://github.com/Geuni620/TIL/blob/main/BreadCrumbs/230725.md#server-component--client-component\" target=\"_blank\" rel=\"nofollow\">TIL 내용 중 230725 기록</a></p>\n<ul>\n<li>이때 거의 다 힌트를 적어놓고서 왜 api 폴더가 static이라는 생각을 못했을까..ㅠㅠ</li>\n</ul>","tableOfContents":"<ul>\n<li><a href=\"#revalidate-time%EC%9D%B4-%EC%A0%81%EC%9A%A9%EB%90%98%EC%A7%80-%EC%95%8A%EB%8A%94%EB%8B%A4\">revalidate time이 적용되지 않는다.</a></li>\n<li><a href=\"#nextjs%EC%9D%98-%EC%9E%90%EC%B2%B4-%EC%98%A4%EB%A5%98%EC%9D%B8%EA%B1%B8%EA%B9%8C\">next.js의 자체 오류인걸까?</a></li>\n<li><a href=\"#%EA%B7%B8%EB%9E%98%EB%8F%84-%ED%95%B4%EA%B2%B0%ED%95%B4%EC%95%BC%ED%95%9C%EB%8B%A4\">그래도 해결해야한다.</a></li>\n<li><a href=\"#%EB%B2%88%EC%99%B8\">번외</a></li>\n</ul>","frontmatter":{"title":"작은 기능 중, 작은 이슈를 해결하기 위해 달렸던 3개월","summary":"대체 왜 google analytics의 views(조회수)는 revalidate time이 적용되지 않는걸까?","date":"2023.08.11.","categories":["개발"]}}}]}},"pageContext":{"slug":"/blog/2023/8/11/trouble-shooting/"}},"staticQueryHashes":["1629908903"]}
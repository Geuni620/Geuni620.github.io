{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/2024/7/7/supabase-rls/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4d88aebab106c8e6a23d8cc6f3ae7497/d71bc/img.webp\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/webp;base64,UklGRvYAAABXRUJQVlA4IOoAAACQBQCdASoUABQAPtFgqE+oJSOiKAgBABoJZQC7M47vcTNukAB5LVVwT2j8vThswtEJb1m5QAD+1v/ZNbS2fPDv+8Ez/zhya8LI0sbZlvQgpw2B/T5I8M66/WDzQez2qQANHV3Yc4YBj+J4W/PlG00kGK6lmX2CtqjFtCdOH2Q2JcsJigmoXcap0ryAvjWRc1AsbCg+e8csE1h2F2BpV9HFFOn9rrCYc3oZ9XAVaOm/yKs2oeWV3aCwOqbZnz/3Ft/cUQMPZGwFzzureJSAjcptCJP+Ok6FAKe3VN030yYJ1PzHKWPF1yAAAAA='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/4d88aebab106c8e6a23d8cc6f3ae7497/a59e9/img.webp 192w,\n/static/4d88aebab106c8e6a23d8cc6f3ae7497/0ca9f/img.webp 384w,\n/static/4d88aebab106c8e6a23d8cc6f3ae7497/dc9b9/img.webp 768w,\n/static/4d88aebab106c8e6a23d8cc6f3ae7497/d71bc/img.webp 1024w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/4d88aebab106c8e6a23d8cc6f3ae7497/a59e9/img.webp 192w,\n/static/4d88aebab106c8e6a23d8cc6f3ae7497/0ca9f/img.webp 384w,\n/static/4d88aebab106c8e6a23d8cc6f3ae7497/dc9b9/img.webp 768w,\n/static/4d88aebab106c8e6a23d8cc6f3ae7497/d71bc/img.webp 1024w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/webp\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/4d88aebab106c8e6a23d8cc6f3ae7497/dc9b9/img.webp\"\n            alt=\"img\"\n            title=\"img\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<blockquote>\n<p><a href=\"https://geuni620.github.io/blog/2024/6/22/supabase-rls/\" target=\"_blank\" rel=\"nofollow\">이전 글</a>을 작성하고 나서 RLS를 적용하던 중, 의문이 생겼다.</p>\n</blockquote>\n<br/>\n<h2 id=\"문제상황\" style=\"position:relative;\"><a href=\"#%EB%AC%B8%EC%A0%9C%EC%83%81%ED%99%A9\" aria-label=\"문제상황 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>문제상황</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/362d167072e39f9150952cef94a4186e/2206a/supabase-rls-authenticated-list.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.1875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABbklEQVQ4y13Uh4pEMQgF0Pz/T84wvffeXI4ghBWCT6PXq5HXTqdTPJ/PuN/v8Xg84na7xWazye/z+Zz+/X6f32KPx2Pq1WqVsQ5b/OVyiXa9XoN8v9/Ur9crDodDfD6fGI1G8X6/E2y328VsNovpdJraIUDG43F+A28qYVSHPZlMsioQej6fpx9TxYCIWSwWsV6vUyskLhliw1Dh9/tFsWaX1lLvU0xeL0bXisVgMMjqEpbLZYK6q5m649tut+krxmZarOE0TtUdFcwLW8n1KFoSVz6AZqggMHcA2U0CwbBaVYmUXcC9YF0PWZKvDFWCg75A1fsV8QDigDo6EaN9MRUnN1t2vJIkl74FmCVtffhrVwEaS83fHUIJaO8cu+RSG+ZCqk1++9hLxfaSe4h2/1rVMrv8bK9q59yblYfCkO2bhtWqheFwmI+gKqAaMgFa+1cC7D9rbTfBEosVUGxqhWjVfVtkNqDax/oP0PL/ABeF5vIZnh/oAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/362d167072e39f9150952cef94a4186e/a59e9/supabase-rls-authenticated-list.webp 192w,\n/static/362d167072e39f9150952cef94a4186e/0ca9f/supabase-rls-authenticated-list.webp 384w,\n/static/362d167072e39f9150952cef94a4186e/dc9b9/supabase-rls-authenticated-list.webp 768w,\n/static/362d167072e39f9150952cef94a4186e/e2c2f/supabase-rls-authenticated-list.webp 1152w,\n/static/362d167072e39f9150952cef94a4186e/f3efb/supabase-rls-authenticated-list.webp 1536w,\n/static/362d167072e39f9150952cef94a4186e/9ad5f/supabase-rls-authenticated-list.webp 2002w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/362d167072e39f9150952cef94a4186e/3b721/supabase-rls-authenticated-list.png 192w,\n/static/362d167072e39f9150952cef94a4186e/66595/supabase-rls-authenticated-list.png 384w,\n/static/362d167072e39f9150952cef94a4186e/fe486/supabase-rls-authenticated-list.png 768w,\n/static/362d167072e39f9150952cef94a4186e/d2d74/supabase-rls-authenticated-list.png 1152w,\n/static/362d167072e39f9150952cef94a4186e/e8464/supabase-rls-authenticated-list.png 1536w,\n/static/362d167072e39f9150952cef94a4186e/2206a/supabase-rls-authenticated-list.png 2002w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/362d167072e39f9150952cef94a4186e/fe486/supabase-rls-authenticated-list.png\"\n            alt=\"supabase rls authenticated list\"\n            title=\"supabase rls authenticated list\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>RLS를 위 이미지처럼 적용해주려고 했다.</p>\n<p>owner / authenticated / every는 각각 다음과 같다.</p>\n<ul>\n<li>owner: 본인이 작성한 글에만 접근 가능</li>\n<li>authenticated: 로그인한 유저에게만 접근 가능</li>\n<li>every: 모든 유저에게 접근 가능</li>\n</ul>\n<br/>\n<p>select / insert / update / delete는 각각 다음과 같다.</p>\n<ul>\n<li>select: 데이터 조회</li>\n<li>insert: 데이터 추가</li>\n<li>update: 데이터 수정</li>\n<li>delete: 데이터 삭제</li>\n</ul>\n<p>즉, 로그인한 유저에게만 데이터 조회가 가능하고,<br>\n데이터의 생성 / 수정 / 삭제는 본인의 글에만 가능하도록 하고 싶었다.</p>\n<p>하지만, RLS를 적용하고 나서 <strong>문제가 발생했다.</strong><br>\n본인글에 대한 데이터는 정상적으로 삭제가 잘 된다.<br>\n하지만 본인글이 아닌 경우 삭제는 불가능하지만,<br>\nmutate의 <strong>onSuccess 메서드 내 소스코드가 동작하는 것</strong>이다.</p>\n<hr>\n<h2 id=\"재현하기\" style=\"position:relative;\"><a href=\"#%EC%9E%AC%ED%98%84%ED%95%98%EA%B8%B0\" aria-label=\"재현하기 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>재현하기</h2>\n<h3 id=\"ui--비즈니스로직-구현\" style=\"position:relative;\"><a href=\"#ui--%EB%B9%84%EC%A6%88%EB%8B%88%EC%8A%A4%EB%A1%9C%EC%A7%81-%EA%B5%AC%ED%98%84\" aria-label=\"ui  비즈니스로직 구현 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>UI &#x26; 비즈니스로직 구현</h3>\n<p>테스트해보자.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7876c8264ddceef43b57a853c1e8437c/b23e8/delete-button.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.645833333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAyUlEQVQY03WQMW/CMBCF/asZujEw95dVXauu0CgMDSSxY/vI+avOIChKOOkNfud799kOoJSy0Cu/Cu59q5QSm7cd2907Ti4XZtXFUM6Crvgm1ULKcjtT7+0PDT9Ni4sx4X14IrLyYSLlvEpqAf0wXhcCyqOcDVlzmuJTYIwRH8IK4ZVo9B4thb7rkClUz+REpBKa9N8f2SLz5nleUmohxIScO9rPD8L3F3ps6tydcLRAfQwZcd8PpLT+7MEH4vmEHFty26Cn3xr4B8T01LcXwN5VAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/7876c8264ddceef43b57a853c1e8437c/a59e9/delete-button.webp 192w,\n/static/7876c8264ddceef43b57a853c1e8437c/0ca9f/delete-button.webp 384w,\n/static/7876c8264ddceef43b57a853c1e8437c/dc9b9/delete-button.webp 768w,\n/static/7876c8264ddceef43b57a853c1e8437c/e2c2f/delete-button.webp 1152w,\n/static/7876c8264ddceef43b57a853c1e8437c/f3efb/delete-button.webp 1536w,\n/static/7876c8264ddceef43b57a853c1e8437c/20c61/delete-button.webp 2224w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/7876c8264ddceef43b57a853c1e8437c/3b721/delete-button.png 192w,\n/static/7876c8264ddceef43b57a853c1e8437c/66595/delete-button.png 384w,\n/static/7876c8264ddceef43b57a853c1e8437c/fe486/delete-button.png 768w,\n/static/7876c8264ddceef43b57a853c1e8437c/d2d74/delete-button.png 1152w,\n/static/7876c8264ddceef43b57a853c1e8437c/e8464/delete-button.png 1536w,\n/static/7876c8264ddceef43b57a853c1e8437c/b23e8/delete-button.png 2224w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/7876c8264ddceef43b57a853c1e8437c/fe486/delete-button.png\"\n            alt=\"delete button\"\n            title=\"delete button\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>해당 버튼을 눌렀을 때, Toast 메시지를 띄우고 삭제를 해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// src/lib/table/columns.tsx</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> columns<span class=\"token operator\">:</span> ColumnDef<span class=\"token operator\">&lt;</span>TaskProps<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token comment\">//...</span>\n\n  <span class=\"token punctuation\">{</span>\n    id<span class=\"token operator\">:</span> <span class=\"token string\">'actions'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">cell</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> row <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> selectedTask <span class=\"token operator\">=</span> row<span class=\"token punctuation\">.</span>original<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> deleteMutation <span class=\"token operator\">=</span> <span class=\"token function\">useTaskDeleteMutation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">onDelete</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> id <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        deleteMutation<span class=\"token punctuation\">.</span><span class=\"token function\">mutate</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">DropdownMenu</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        // trigger\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">DropdownMenuTrigger</span></span> <span class=\"token attr-name\">asChild</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Button</span></span> <span class=\"token attr-name\">variant</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>ghost<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>size-8 p-0<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n              </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sr-only<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Open menu</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n              </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MoreHorizontal</span></span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>size-4<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Button</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">DropdownMenuTrigger</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\n          // content\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">DropdownMenuContent</span></span> <span class=\"token attr-name\">align</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>end<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">DropdownMenuLabel</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Actions</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">DropdownMenuLabel</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">DropdownMenuSeparator</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">DropdownMenuItem</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Edit</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">DropdownMenuItem</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">DropdownMenuItem</span></span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">onDelete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> selectedTask<span class=\"token punctuation\">.</span>id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n              Delete\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">DropdownMenuItem</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">DropdownMenuContent</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">DropdownMenu</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Tanstack-table을 사용하고 있어서, <code class=\"language-text\">columns.tsx</code> 내 id action으로 DropdownMenu를 만들어주었다.</p>\n<br/>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">deleteTask</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> error <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> supabase<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TASK</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    message<span class=\"token operator\">:</span> <span class=\"token string\">'데이터를 성공적으로 삭제하였습니다.'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useTaskDeleteMutation</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> queryClient <span class=\"token operator\">=</span> <span class=\"token function\">useQueryClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token function\">useMutation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    mutationFn<span class=\"token operator\">:</span> deleteTask<span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">onSuccess</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> message <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">invalidateQueries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> queryKey<span class=\"token operator\">:</span> taskKeys<span class=\"token punctuation\">.</span>all <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      toast<span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token function-variable function\">onError</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      toast<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">useTaskDeleteMutation</code>을 만들어주었다.<br>\nsupabase의 DB 테이블 내, id와 동일한 데이터를 삭제해줄 것이다.</p>\n<br/>\n<h3 id=\"delete-rls-적용\" style=\"position:relative;\"><a href=\"#delete-rls-%EC%A0%81%EC%9A%A9\" aria-label=\"delete rls 적용 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Delete RLS 적용</h3>\n<p><a href=\"https://geuni620.github.io/blog/2024/6/22/supabase-rls/#3-row-level-security-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0\" target=\"_blank\" rel=\"nofollow\">이전 글에서</a> RLS Select 적용방법은 작성해두었다.<br>\nDelete도 적용해보자.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f2af4b9a76d5b8904f1e51ce290defd0/e2156/supabase-delete-rls.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 63.020833333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAACP0lEQVQ4y3VT247bIBD1/39Iv2RVtVLVh7ZKduPEduwYMOZmwIlvu6casslDpT4cDYiZw5nDkDHG0LYtHpHgnIP3HsMwpEh7pRSauk776/WK2+2WQGvCOI4pZpxzGGOeoGIpZUKMMSVRJCLtLbQzMFo/8+nsQZYI67oGkZLCvu8TIYHUPZKoKISAuM6wwaMTAp2UKYfIHhcvy4Ks1xrj9S59nucUU/GnKlpTIcVtGnEbAwbvn2eUR3XrumKaJmSiqaEYA7s0SZnWKrVUn8/gnMFae/c0BLzPAWEwYJxDCJF8pTMiJkIizvjbHip/hT3sUpEjRSGgNwb6s/VU5D3itCGME2LwGKnNcUwPsy5LwkwK+fcXqB9f4X5+gytyuOoEVx4xVAV8dcRgbTKfLvMroPyIC02DEGBCgEuZLiYh87Yhq8oK+Z/fOL7ucSlL8PoMVpVgTQO5+wUjWFLreIuPrsWtrWFOB/hzgYk1mPgFs2ixdAwza5C9lmfs9jvIvoemNglaQzkHU+TQnEEai6HIsfUCQfcQrIVkDKK9pOiNRowBc/GG7NJ7MN6jUz2k0lDGwBJZiKl92wlo8rHI8UG+eQ/FGbxWuA4uIRLhMNwJXXmCK45wZX73Lvn36eFhB6fV/XFkh609YmxOMJRPXlcn+LrEIjnWXmCWHFmwBsHaf2ASPCmII9Z4Q4wj3j82+BjQMI5OKShjk79mGGB9wLSuyNLr/QdxCNjLM76UL+BO4X3d0vDSuNCI0M9Y5vkJGuy/yXPXAfTdXu8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f2af4b9a76d5b8904f1e51ce290defd0/a59e9/supabase-delete-rls.webp 192w,\n/static/f2af4b9a76d5b8904f1e51ce290defd0/0ca9f/supabase-delete-rls.webp 384w,\n/static/f2af4b9a76d5b8904f1e51ce290defd0/dc9b9/supabase-delete-rls.webp 768w,\n/static/f2af4b9a76d5b8904f1e51ce290defd0/e2c2f/supabase-delete-rls.webp 1152w,\n/static/f2af4b9a76d5b8904f1e51ce290defd0/f3efb/supabase-delete-rls.webp 1536w,\n/static/f2af4b9a76d5b8904f1e51ce290defd0/bad56/supabase-delete-rls.webp 2374w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f2af4b9a76d5b8904f1e51ce290defd0/3b721/supabase-delete-rls.png 192w,\n/static/f2af4b9a76d5b8904f1e51ce290defd0/66595/supabase-delete-rls.png 384w,\n/static/f2af4b9a76d5b8904f1e51ce290defd0/fe486/supabase-delete-rls.png 768w,\n/static/f2af4b9a76d5b8904f1e51ce290defd0/d2d74/supabase-delete-rls.png 1152w,\n/static/f2af4b9a76d5b8904f1e51ce290defd0/e8464/supabase-delete-rls.png 1536w,\n/static/f2af4b9a76d5b8904f1e51ce290defd0/e2156/supabase-delete-rls.png 2374w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f2af4b9a76d5b8904f1e51ce290defd0/fe486/supabase-delete-rls.png\"\n            alt=\"supabase delete rls\"\n            title=\"supabase delete rls\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>supabase에서 제공해주는 Delete Template에서 하나만 수정했는데,<br>\n<code class=\"language-text\">to</code> 절에 <code class=\"language-text\">authenticated</code>를 추가해주었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> policy <span class=\"token string\">\"Enable delete for users based on user_id\"</span>\n<span class=\"token keyword\">on</span> <span class=\"token string\">\"public\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"tasks_rls\"</span>\n<span class=\"token keyword\">as</span> PERMISSIVE\n<span class=\"token keyword\">for</span> <span class=\"token keyword\">DELETE</span>\n<span class=\"token keyword\">to</span> authenticated <span class=\"token comment\">-- public → authenticated</span>\n<span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">(</span><span class=\"token keyword\">select</span> auth<span class=\"token punctuation\">.</span>uid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> user_id\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>이제 로그인한 사용자만 삭제 가능한지 확인해보자.</p>\n<br/>\n<p>하지만 위에서 언급했던 문제의 상황이 발생했다.<br>\n삭제 문구는 정상적으로 동작하는데, 삭제가 되지 않는 것이다.</p>\n<p>명확히 구분하기 위해 columns을 하나 더 추가해보았다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> columns<span class=\"token operator\">:</span> ColumnDef<span class=\"token operator\">&lt;</span>TaskProps<span class=\"token operator\">></span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n <span class=\"token comment\">//...</span>\n  <span class=\"token punctuation\">{</span>\n    accessorKey<span class=\"token operator\">:</span> <span class=\"token string\">'author'</span><span class=\"token punctuation\">,</span>\n    header<span class=\"token operator\">:</span> <span class=\"token string\">'Author'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">cell</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> row <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> userId <span class=\"token operator\">=</span> row<span class=\"token punctuation\">.</span>original<span class=\"token punctuation\">.</span>userId<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> session <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useLogin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">const</span> isMyTask <span class=\"token operator\">=</span> session<span class=\"token operator\">?.</span>user<span class=\"token operator\">?.</span>id <span class=\"token operator\">===</span> userId<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> authorText <span class=\"token operator\">=</span> isMyTask <span class=\"token operator\">?</span> <span class=\"token string\">'내가 작성함'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'내가 작성안함'</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> textColor <span class=\"token operator\">=</span> isMyTask <span class=\"token operator\">?</span> <span class=\"token string\">'text-blue-600'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'text-red-600'</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">font-medium </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>textColor<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>authorText<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">//...</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>내가 작성한 글일 경우, ‘내가 작성함’이라는 문구가 뜨도록 하였다.</p>\n<p><img src=\"/8ebd57f2c5a01517e30787dd34cb1ecd/test.gif\" alt=\"\"></p>\n<p>위 GIF처럼, 내가 작성한 글(파란색)은 삭제가 되지만,<br>\n내가 작성하지 않은 글(빨간색)은 삭제되지 않는다.<br>\n하지만, 메시지는 여전히 <code class=\"language-text\">데이터를 성공적으로 삭제하였습니다.</code>가 떠서 혼란스럽다.</p>\n<p>네트워크 탭을 열어서 확인해보면, 사실 아무것도 반환하지 않는다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0b747727aa62b8a63cbcb30b26b92313/b88a2/no-return-anything.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.145833333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAfUlEQVQI143M2w6CMBREUf7/L61KYsGea4EWyBga1PjmJCvztrvbgxHijKQFSY9fkOQw49lMEK+QvIK9fpCVX7qAvaC7hIBrCKjrivfYBPe+BxE3iQhEBDWDnVgEqgZ3by+iyDmjG8YRMUZs2zdok2MYBzBzC7kb9n3HP3sBPaznifVFExsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/0b747727aa62b8a63cbcb30b26b92313/a59e9/no-return-anything.webp 192w,\n/static/0b747727aa62b8a63cbcb30b26b92313/0ca9f/no-return-anything.webp 384w,\n/static/0b747727aa62b8a63cbcb30b26b92313/dc9b9/no-return-anything.webp 768w,\n/static/0b747727aa62b8a63cbcb30b26b92313/e2c2f/no-return-anything.webp 1152w,\n/static/0b747727aa62b8a63cbcb30b26b92313/f3efb/no-return-anything.webp 1536w,\n/static/0b747727aa62b8a63cbcb30b26b92313/6a1cb/no-return-anything.webp 1844w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/0b747727aa62b8a63cbcb30b26b92313/3b721/no-return-anything.png 192w,\n/static/0b747727aa62b8a63cbcb30b26b92313/66595/no-return-anything.png 384w,\n/static/0b747727aa62b8a63cbcb30b26b92313/fe486/no-return-anything.png 768w,\n/static/0b747727aa62b8a63cbcb30b26b92313/d2d74/no-return-anything.png 1152w,\n/static/0b747727aa62b8a63cbcb30b26b92313/e8464/no-return-anything.png 1536w,\n/static/0b747727aa62b8a63cbcb30b26b92313/b88a2/no-return-anything.png 1844w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/0b747727aa62b8a63cbcb30b26b92313/fe486/no-return-anything.png\"\n            alt=\"no return anything\"\n            title=\"no return anything\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<br/>\n<h2 id=\"원인분석\" style=\"position:relative;\"><a href=\"#%EC%9B%90%EC%9D%B8%EB%B6%84%EC%84%9D\" aria-label=\"원인분석 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>원인분석</h2>\n<p>처음엔 버그라고 생각했다.<br>\nsupabase의 github issue에서 관련된 내용을 검색하다가 <a href=\"https://github.com/supabase/supabase-js/issues/902\" target=\"_blank\" rel=\"nofollow\">이슈 하나</a>를 발견했다.<br>\n나와 동일한 문제를 경험한 것 같았고, <a href=\"https://github.com/supabase/supabase-js/issues/902#issuecomment-1824702735\" target=\"_blank\" rel=\"nofollow\">답변</a>에서 버그가 아닌 것을 확인했다.</p>\n<br/>\n<p>그럼 권한 없는 사람이 Delete 요청을 보내면, <strong>적절한 메시지를 띄울 수 있는 방법은 없는 것일까..?</strong></p>\n<br/>\n<h2 id=\"해결하기\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0\" aria-label=\"해결하기 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결하기</h2>\n<p>Claude에게 해당 고민에 대해 질문했는데, 코드를 하나 짜주었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token operator\">OR</span> <span class=\"token keyword\">REPLACE</span> <span class=\"token keyword\">FUNCTION</span> <span class=\"token keyword\">public</span><span class=\"token punctuation\">.</span>delete_task<span class=\"token punctuation\">(</span>task_id UUID<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">RETURNS</span> JSONB\n<span class=\"token keyword\">LANGUAGE</span> plpgsql\nSECURITY <span class=\"token keyword\">INVOKER</span>\n<span class=\"token keyword\">AS</span> $$\n<span class=\"token keyword\">DECLARE</span>\n    task_exists <span class=\"token keyword\">BOOLEAN</span><span class=\"token punctuation\">;</span>\n    rows_affected <span class=\"token keyword\">INT</span><span class=\"token punctuation\">;</span>\n    result JSONB<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">BEGIN</span>\n    <span class=\"token comment\">-- 작업 삭제 시도 (RLS가 자동으로 적용됨)</span>\n    <span class=\"token keyword\">WITH</span> deleted_rows <span class=\"token keyword\">AS</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">DELETE</span> <span class=\"token keyword\">FROM</span> tasks_rls\n        <span class=\"token keyword\">WHERE</span> id <span class=\"token operator\">=</span> task_id\n        <span class=\"token keyword\">RETURNING</span> id\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">SELECT</span> <span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">INTO</span> rows_affected <span class=\"token keyword\">FROM</span> deleted_rows<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">IF</span> rows_affected <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token keyword\">THEN</span>\n        <span class=\"token comment\">-- 작업이 존재하는지 확인</span>\n        <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">EXISTS</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> <span class=\"token number\">1</span> <span class=\"token keyword\">FROM</span> tasks_rls <span class=\"token keyword\">WHERE</span> id <span class=\"token operator\">=</span> task_id<span class=\"token punctuation\">)</span> <span class=\"token keyword\">INTO</span> task_exists<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">IF</span> task_exists <span class=\"token keyword\">THEN</span>\n            RAISE EXCEPTION <span class=\"token string\">'작업을 삭제할 권한이 없습니다.'</span> <span class=\"token keyword\">USING</span> ERRCODE <span class=\"token operator\">=</span> <span class=\"token string\">'UNAUTHORIZED'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">ELSE</span>\n            RAISE EXCEPTION <span class=\"token string\">'작업을 찾을 수 없습니다.'</span> <span class=\"token keyword\">USING</span> ERRCODE <span class=\"token operator\">=</span> <span class=\"token string\">'NOT_FOUND'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">END</span> <span class=\"token keyword\">IF</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">END</span> <span class=\"token keyword\">IF</span><span class=\"token punctuation\">;</span>\n\n    result :<span class=\"token operator\">=</span> jsonb_build_object<span class=\"token punctuation\">(</span><span class=\"token string\">'success'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'message'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'작업이 성공적으로 삭제되었습니다.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">RETURN</span> result<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">END</span><span class=\"token punctuation\">;</span>\n$$<span class=\"token punctuation\">;</span></code></pre></div>\n<p>SQL문법은 하나도 몰라서 검색을 좀 해봤는데, <a href=\"https://supabase.com/docs/guides/database/functions?language=js&#x26;queryGroups=example-view&#x26;example-view=data\" target=\"_blank\" rel=\"nofollow\">Database Function</a>이라는 것을 알게됐다.<br>\n그리고 이를 통해 Postgres에 원하는 동작을 수행할 수 있다.</p>\n<br/>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7c16c93637c386953ee9e0a63bbc0c94/d7fb2/rpc-function.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.77083333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAACOElEQVQ4y22U2W7bMBBF9f9f1T41QNH2IWgSJHHqyNbCbbhJJuWguMXQYqosD9dDmZjD2cim9xrOWgghcDqdkHNGSicQWShp4ZyD977sG2MQQsA4CiilMM9z8dmqiSkhxgitNXJKWHIuG0Ia3N7u8PDwUGC8z0BjqFj+5sPYlw+pauz1Txitoa1FPp+RlgVzSpCKsG9bjGKEtbY4TtP0auuaIWyrGrr6iigGuLFHVAKzloiWQM6j73scDoeiCt1GU2FbaBOdhfpxheP3b1DXvzDd/0a4v4HUGsOg0PdHCDFCa7um6d+APwCdJWSjkFbxetIKighkPO7uBHa7EcMwFsdpikUV8CFlLmw+v5T6Fb28YDqlC5Ai9nuPYaASobVsfZkAIvoQYWkKF5e7m1blnErBGaiVQ9d1Jbo/ewEpudMexnwOvNQwxnX2KjBjmmZITfDe4XjUaNsjnp4UhIggMpDSr5EaCOGhlXmd0YZ/GFKhb4EeXSfQti12Ty06I9GRxGg1BuFxOAgILXFc/3sDfB9hSVkHPD+bEglx/ZyF8RbGOSjpy/zyt3KEuKbd8PWpoGpjAVqIkUdngNIKRhsYbpR3IAoXsHfQjoqkMyDn0GxB1fIhveT6rNGRLekXhQDvA1xZVwW44GG9R7NNdQvkzRDD/yu2mbX31680dprxd14+B/LjwC8Q15fntDrXl4ft5aG4dDZYh0fT4Yu4+RzIlq9ZnTGGnfnhWPdrFnzwsizIKUPMDjehwz/oasJ6//GLuQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/7c16c93637c386953ee9e0a63bbc0c94/a59e9/rpc-function.webp 192w,\n/static/7c16c93637c386953ee9e0a63bbc0c94/0ca9f/rpc-function.webp 384w,\n/static/7c16c93637c386953ee9e0a63bbc0c94/dc9b9/rpc-function.webp 768w,\n/static/7c16c93637c386953ee9e0a63bbc0c94/e2c2f/rpc-function.webp 1152w,\n/static/7c16c93637c386953ee9e0a63bbc0c94/f3efb/rpc-function.webp 1536w,\n/static/7c16c93637c386953ee9e0a63bbc0c94/7eed9/rpc-function.webp 2184w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/7c16c93637c386953ee9e0a63bbc0c94/3b721/rpc-function.png 192w,\n/static/7c16c93637c386953ee9e0a63bbc0c94/66595/rpc-function.png 384w,\n/static/7c16c93637c386953ee9e0a63bbc0c94/fe486/rpc-function.png 768w,\n/static/7c16c93637c386953ee9e0a63bbc0c94/d2d74/rpc-function.png 1152w,\n/static/7c16c93637c386953ee9e0a63bbc0c94/e8464/rpc-function.png 1536w,\n/static/7c16c93637c386953ee9e0a63bbc0c94/d7fb2/rpc-function.png 2184w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/7c16c93637c386953ee9e0a63bbc0c94/fe486/rpc-function.png\"\n            alt=\"rpc function\"\n            title=\"rpc function\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>위와 같이 붙여넣고 Run을 실행했을 때, Success가 뜨는 것을 확인했다.</p>\n<br/>\n<p>테스트 해보자.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/45f1c5704a36c7897b16d0ce333634a0/e2af0/not-authorization.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.97916666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABCUlEQVQoz43R7W6CMBhAYe7/7pZlyzJAgVIEphOltbTAexbBTP/so8mTpn9O3raR0hVlVWOsw4eJMAlhnAkzBHthTN7w+z0ufcelKWNTI6cj0n3eHQ9If0biFyJVapr2g2kWxulqXglM1jJVJV7Aas3l0OF7w+jc3TAwGoM3lilL1mBeKI7dmVlYot/xMDJnMaI2oHPQGajtcl5tbzZImSHJK1FZarK84HTuGfzI4ANu8Et0mkEARJAH/ASIurYmVxql1klLvWObFTTtHjcE1p4s4T+JEFVFQZykZHlO07bLe9ZNQ7Xbce7NPfjbZA+i9vmJOok5NNefthjTY6xZ9otz65W5Bf+xvgBN4xztvOWnMgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/45f1c5704a36c7897b16d0ce333634a0/a59e9/not-authorization.webp 192w,\n/static/45f1c5704a36c7897b16d0ce333634a0/0ca9f/not-authorization.webp 384w,\n/static/45f1c5704a36c7897b16d0ce333634a0/dc9b9/not-authorization.webp 768w,\n/static/45f1c5704a36c7897b16d0ce333634a0/e2c2f/not-authorization.webp 1152w,\n/static/45f1c5704a36c7897b16d0ce333634a0/f3efb/not-authorization.webp 1536w,\n/static/45f1c5704a36c7897b16d0ce333634a0/b135c/not-authorization.webp 1650w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/45f1c5704a36c7897b16d0ce333634a0/3b721/not-authorization.png 192w,\n/static/45f1c5704a36c7897b16d0ce333634a0/66595/not-authorization.png 384w,\n/static/45f1c5704a36c7897b16d0ce333634a0/fe486/not-authorization.png 768w,\n/static/45f1c5704a36c7897b16d0ce333634a0/d2d74/not-authorization.png 1152w,\n/static/45f1c5704a36c7897b16d0ce333634a0/e8464/not-authorization.png 1536w,\n/static/45f1c5704a36c7897b16d0ce333634a0/e2af0/not-authorization.png 1650w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/45f1c5704a36c7897b16d0ce333634a0/fe486/not-authorization.png\"\n            alt=\"not authorization\"\n            title=\"not authorization\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>권한이 없는 아이디로 삭제버튼을 클릭했을 때, 네트워크 탭에서 다음과 같은 Response를 내려준다.<br>\n이를통해 클라이언트에서 적절히 Error 메시지를 띄워줄 수 있을 것이다.</p>\n<br/>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p>사실 이게 <strong>옳은 방법인지 잘 모르겠다.</strong><br>\nRLS를 적용해보면서, 권한이 없는 유저가 해당 데이터를 삭제하려고 할 때,<br>\n권한없음 에러가 내려오지 않는 것을 확인했고, 이를 RPC를 통해 해결해본 것이다.</p>\n<p>한 가지 흥미로운 변화는, 내가 이 사례를 통해 SQL에 관심이 간다는 점이다.<br>\n필요하지 않으면 학습하지 않았는데, 이번 계기로 SQL에 대해 조금 더 알아보고 싶어졌다.<br>\n적어도, 위에서 Claude가 적어준 SQL문을 읽고 해석할 정도는 되어야할 것 같다. 😭</p>\n<br/>\n<h3 id=\"참고자료\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0%EC%9E%90%EB%A3%8C\" aria-label=\"참고자료 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참고자료</h3>\n<p><a href=\"https://github.com/supabase/supabase-js/issues/902\" target=\"_blank\" rel=\"nofollow\">error is always null if delete is not successful due to RLS policy #902</a><br>\n<a href=\"https://supabase.com/docs/guides/database/functions?language=js&#x26;queryGroups=example-view&#x26;example-view=data\" target=\"_blank\" rel=\"nofollow\">Database Functions</a></p>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C%EC%83%81%ED%99%A9\">문제상황</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%9E%AC%ED%98%84%ED%95%98%EA%B8%B0\">재현하기</a></p>\n<ul>\n<li><a href=\"#ui--%EB%B9%84%EC%A6%88%EB%8B%88%EC%8A%A4%EB%A1%9C%EC%A7%81-%EA%B5%AC%ED%98%84\">UI &#x26; 비즈니스로직 구현</a></li>\n<li><a href=\"#delete-rls-%EC%A0%81%EC%9A%A9\">Delete RLS 적용</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%9B%90%EC%9D%B8%EB%B6%84%EC%84%9D\">원인분석</a></p>\n</li>\n<li>\n<p><a href=\"#%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0\">해결하기</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%A0%95%EB%A6%AC\">정리</a></p>\n<ul>\n<li><a href=\"#%EC%B0%B8%EA%B3%A0%EC%9E%90%EB%A3%8C\">참고자료</a></li>\n</ul>\n</li>\n</ul>","frontmatter":{"title":"supabase RPC로 Response 메시지 커스텀하기","summary":"","date":"2024.07.07.","categories":["개발"]}}}]}},"pageContext":{"slug":"/blog/2024/7/7/supabase-rls/"}},"staticQueryHashes":["1629908903"]}
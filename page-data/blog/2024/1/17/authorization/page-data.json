{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/2024/1/17/authorization/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<ul>\n<li>작성했던 관련 글<br>\n<a href=\"https://geuni620.github.io/blog/2023/8/18/next-auth/\" target=\"_blank\" rel=\"nofollow\">next-auth token 관리하기-1</a><br>\n<a href=\"https://geuni620.github.io/blog/2023/8/24/next-auth/\" target=\"_blank\" rel=\"nofollow\">next-auth token 관리하기-2</a><br>\n<a href=\"https://geuni620.github.io/blog/2023/8/28/next-auth/\" target=\"_blank\" rel=\"nofollow\">next-auth token 관리하기-3</a><br>\n<a href=\"https://geuni620.github.io/blog/2023/9/10/next-auth/\" target=\"_blank\" rel=\"nofollow\">next-auth token 관리하기-4</a></li>\n</ul>\n<br/>\n<h1 id=\"1-token의-필요성\" style=\"position:relative;\"><a href=\"#1-token%EC%9D%98-%ED%95%84%EC%9A%94%EC%84%B1\" aria-label=\"1 token의 필요성 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Token의 필요성</h1>\n<p>사이드프로젝트를 진행하다가 의문점이 하나 생겼다.<br>\nnext-auth를 사용해 로그인을 했는데(=인증),<br>\n<strong>API요청시 Token을 header에 포함시켜서 요청을 보내지 않는다.</strong>(=인가)</p>\n<p>요청을 보낼 때 유저를 구분하는 기준이 <code class=\"language-text\">userId</code>이다.<br>\n<strong>즉, Token을 전혀 사용하고 있지 않다.</strong></p>\n<br/>\n<p>머리속에 의문점이 떠올랐다.</p>\n<blockquote>\n<p>💬 userId를 다른 사용자가 알고 있다면, postman이나, thunder-client로 DB 데이터를 꺼내오거나,<br>\n수정할 수 있는 거 아닌가? 심지어 삭제까지.</p>\n</blockquote>\n<p>그래서 확인해보고 싶어졌다. 과연, userId를 알고 있다면 DB에 데이터를 보낼 수 있을까?</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f58547be52f058831a14fd4aef3010b4/3f8e8/thuner-client.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABXElEQVQoz22R2W7bMBBF9SupNrtBHK1cRIm0KMtxEjgv/f9vOQUpIW6LPlxyBrxzcAdMTuaMvLzT+xtiuaGvnzTnlbxRHOWEfL9zlCOdW/lpDZmRhJmjHSgHHetiUGSNJKslyaE3cbDsBqpp4WTmWB/FRHgrWh17dfmgmnyEl/1I3htKYTiI0A9bADGShKNoh6g8DhvK/qHtXfP0KmjMgLtYGj0i1UjZKNJKkNcyAp/lRBIiHzpN2SryelNWbfGLYFIhvSarFb2dIlDOjuW60FlL0ekIC/64srCG+5fHf3jc18r860Z9djtkB7cbcPIT/uoYlhl584g3T+3sNzDcyUkbhB15GSfa5YxYZ561IW8fpgBMa8VytXzeZ8wyI7yj8Y6y19++mDCtJU+vkrSS/DiJqHRf+U9g1iiqweBWixwnFut46Ybo/Sth3mzF//QAqvhh8fP2vtyV/TPzG1YSAlFSNOw+AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f58547be52f058831a14fd4aef3010b4/a59e9/thuner-client.webp 192w,\n/static/f58547be52f058831a14fd4aef3010b4/0ca9f/thuner-client.webp 384w,\n/static/f58547be52f058831a14fd4aef3010b4/dc9b9/thuner-client.webp 768w,\n/static/f58547be52f058831a14fd4aef3010b4/e2c2f/thuner-client.webp 1152w,\n/static/f58547be52f058831a14fd4aef3010b4/f3efb/thuner-client.webp 1536w,\n/static/f58547be52f058831a14fd4aef3010b4/4c6e1/thuner-client.webp 1976w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f58547be52f058831a14fd4aef3010b4/3b721/thuner-client.png 192w,\n/static/f58547be52f058831a14fd4aef3010b4/66595/thuner-client.png 384w,\n/static/f58547be52f058831a14fd4aef3010b4/fe486/thuner-client.png 768w,\n/static/f58547be52f058831a14fd4aef3010b4/d2d74/thuner-client.png 1152w,\n/static/f58547be52f058831a14fd4aef3010b4/e8464/thuner-client.png 1536w,\n/static/f58547be52f058831a14fd4aef3010b4/3f8e8/thuner-client.png 1976w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f58547be52f058831a14fd4aef3010b4/fe486/thuner-client.png\"\n            alt=\"큰일이다;\"\n            title=\"큰일이다;\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">큰일이다;</figcaption>\n  </figure></p>\n<p>위 이미지처럼 vercel로 임시 배포한 상태로 thunder-client에 데이터를 요청해봤다.<br>\n<code class=\"language-text\">userId</code>와 <code class=\"language-text\">recipientId</code>는 사용자가 다른사람에게 공유하기 위해, 노출되는 부분이다.<br>\n즉, 누구나 쉽게 확인 가능하다.</p>\n<p>그렇다면 <code class=\"language-text\">userId</code>나, <code class=\"language-text\">recipientId</code>만 알고 있다면 누구나 DB 데이터를 요청할 수 있고, 삭제도 가능하다는 것이다. 만약 DB의 데이터를 보호해야한다면, <code class=\"language-text\">userId</code>만으로 서버 데이터를 반환하기엔 무리가 있다고 생각되었다.</p>\n<p><strong>이때 Token이 필요하다.</strong></p>\n<blockquote>\n<p>참고로 기획 특성상, 사이드프로젝트에선 Token이 필요하지 않다. 익명으로 누구나 글을 쓸 수 있도록 했고, Delete API는 존재하지 않기 때문이다.</p>\n</blockquote>\n<br/>\n<h1 id=\"2-next-auth-token-관리-방법\" style=\"position:relative;\"><a href=\"#2-next-auth-token-%EA%B4%80%EB%A6%AC-%EB%B0%A9%EB%B2%95\" aria-label=\"2 next auth token 관리 방법 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. next-auth Token 관리 방법</h1>\n<p>next-auth의 token을 관리하는 방법에 대해서 알아보자.<br>\nnext-auth에선 크게 Token을 관리하는 방법을 <a href=\"https://next-auth.js.org/getting-started/upgrade-v4#session-strategy\" target=\"_blank\" rel=\"nofollow\">2가지</a> 소개한다.<br>\n첫번째는, <strong>JWT로 관리하는 방법</strong>이고, 두 번째는 <strong>DB에서 관리하는 방법</strong>이다.</p>\n<p>이전 글을 쓸 당시엔, <strong>DB에 token 정보를 담고 싶지 않았다.</strong><br>\n(당시엔 임시로그인 성향이 강했다. 변경될 여지가 많았기 때문에, DB에서 관리하고 싶지 않았다.)</p>\n<p>그래서 JWT를 사용했다.<br>\nJWT가 아닌, DB에서 Token을 관리하려면 next-auth에선 편하게 <a href=\"https://next-auth.js.org/adapters\" target=\"_blank\" rel=\"nofollow\">adapter</a>를 제공해준다.</p>\n<p>JWT로 Token을 관리할 때 크게 session, access, refresh token을 사용했다.<br>\n여기서 session은 인증을, access와 refresh는 인가에 사용했다.</p>\n<br/>\n<h2 id=\"2-1-인증authentication과-인가authorization가-뭘까\" style=\"position:relative;\"><a href=\"#2-1-%EC%9D%B8%EC%A6%9Dauthentication%EA%B3%BC-%EC%9D%B8%EA%B0%80authorization%EA%B0%80-%EB%AD%98%EA%B9%8C\" aria-label=\"2 1 인증authentication과 인가authorization가 뭘까 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-1. 인증(Authentication)과 인가(Authorization)가 뭘까?</h2>\n<p>초반에는 둘의 개념이 너무 헷갈렸다.\n이를 가장 잘 설명해준 <a href=\"https://youtu.be/y0xMXlOAfss?si=6oSS8O34KMrJhaS3&#x26;t=62\" target=\"_blank\" rel=\"nofollow\">영상</a>을 찾았다.</p>\n<p>해당 영상의 설명을 조금 빌려서 이야기해보자면,<br>\n(나는.. 이상하게 군대밖에 생각나지 않는다.)</p>\n<p>휴가를 다녀온 21살의 나, 첫 휴가 복귀할 때 위병소에서 휴가증을 보여주며 복귀를 알린다.\n이때 나의 신원을 조회하는 헌병들, 휴가복귀자임을 확인한 후 위병소를 통과시켜준다.\n이게 인증이라고 이해했다.</p>\n<br/>\n<p>복귀하고 일 주일 후, 훈련에 참여하게 된 나.<br>\n내일 있을 사격훈련을 위해 미리 연습한다는 선임<br>\n나에게 총기를 가져오라고 시킨다. 나는, 총기보관함에 뚜벅뚜벅 걸어가지만, 그 앞에 서있는 경계병들.<br>\n그들은 나에게 신원을 확인하지만, 총기보관함에서 총기를 가져갈 권한이 없는 나는 그대로 돌아오게 된다.<br>\n이게 인가라고 이해했다.</p>\n<br/>\n<p>즉 다시 정리해보면 다음과 같다.</p>\n<blockquote>\n<p>인증(Authentication): 서비스에 등록된 유저의 신원을 입증하는 과정 (=로그인)<br>\n인가(Authorization): 인증된 사용자에 대한 자원 접근 권한 확인 (=API 요청에 따른 해당 유저의 데이터 반환)</p>\n</blockquote>\n<br/>\n<h1 id=\"3-next-auth는-인증을-어떻게-유지할까\" style=\"position:relative;\"><a href=\"#3-next-auth%EB%8A%94-%EC%9D%B8%EC%A6%9D%EC%9D%84-%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%9C%A0%EC%A7%80%ED%95%A0%EA%B9%8C\" aria-label=\"3 next auth는 인증을 어떻게 유지할까 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. next-auth는 인증을 어떻게 유지할까?</h1>\n<p>next-auth로 간단히 login을 구현해보자.<br>\n이번에도 DB에 Token을 저장하지 않고, <strong>JWT를 사용했다.</strong><br>\n그리고 이를 위해, google oauth를 사용했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// app/api/auth/[...nextauth].ts</span>\n<span class=\"token keyword\">import</span> NextAuth <span class=\"token keyword\">from</span> <span class=\"token string\">'next-auth/next'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> GoogleProvider <span class=\"token keyword\">from</span> <span class=\"token string\">'next-auth/providers/google'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> handler <span class=\"token operator\">=</span> <span class=\"token function\">NextAuth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  secret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NEXTAUTH_SECRET</span><span class=\"token punctuation\">,</span>\n  providers<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token function\">GoogleProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      clientId<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">GOOGLE_CLIENT_ID</span> <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n      clientSecret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">GOOGLE_CLIENT_SECRET</span> <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  session<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    strategy<span class=\"token operator\">:</span> <span class=\"token string\">'jwt'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// Seconds - How long until an idle ses</span>\n    maxAge<span class=\"token operator\">:</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span> <span class=\"token operator\">*</span> <span class=\"token number\">30</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 30 days</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span> handler <span class=\"token keyword\">as</span> <span class=\"token constant\">GET</span><span class=\"token punctuation\">,</span> handler <span class=\"token keyword\">as</span> <span class=\"token constant\">POST</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>인증과정을 거쳐서 로그인이 됐다!</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b6eb989c6ef285e148aa3371b54b58b0/5e075/success-login.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.833333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABPklEQVQoz52RS1PCMBSF8///kAudcUGRogio4wB9lz5om6SFAm3VxXHuhTJsXMjim5ucSXLuuRF39w94HBgYvUwwME2sPB8r17sZYZhjDMfPWDgOFrYD2w9uJwghoiRFua0hdYVCaeSFYrJc/otcKoRRApHlBeIkxTpKoFSJen9kmvbrwrHpmMOxxeHQnmvD7M80TceNCF1tkecSk9cZojiF7XhYLC1IVTKF1Ki2Ncpqx0b9w71Jb9p235C6hKCDhDF8guP6WK5sTKdzNhiZYxjDEWbzN7x/fLJZkmaIkw2CMIIfrOF6PizbhesFrAmpNDZZwZEpPnW0jmKeC3VMOtUeSpNucuZaJyOqgmLRJc8PeAbkbtkOa5blwPPDi0aVol3H7Pdt94NdvYeI6DN0dZkZocvT/lrv15TgbxR+AeMAl5WgbFUcAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/b6eb989c6ef285e148aa3371b54b58b0/a59e9/success-login.webp 192w,\n/static/b6eb989c6ef285e148aa3371b54b58b0/0ca9f/success-login.webp 384w,\n/static/b6eb989c6ef285e148aa3371b54b58b0/dc9b9/success-login.webp 768w,\n/static/b6eb989c6ef285e148aa3371b54b58b0/e2c2f/success-login.webp 1152w,\n/static/b6eb989c6ef285e148aa3371b54b58b0/f3741/success-login.webp 1338w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/b6eb989c6ef285e148aa3371b54b58b0/3b721/success-login.png 192w,\n/static/b6eb989c6ef285e148aa3371b54b58b0/66595/success-login.png 384w,\n/static/b6eb989c6ef285e148aa3371b54b58b0/fe486/success-login.png 768w,\n/static/b6eb989c6ef285e148aa3371b54b58b0/d2d74/success-login.png 1152w,\n/static/b6eb989c6ef285e148aa3371b54b58b0/5e075/success-login.png 1338w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/b6eb989c6ef285e148aa3371b54b58b0/fe486/success-login.png\"\n            alt=\"로그인이 됐다!\"\n            title=\"로그인이 됐다!\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">로그인이 됐다!</figcaption>\n  </figure></p>\n<p>하지만 next-auth는 이 로그인을 어떻게 유지하는걸까?<br>\n페이지를 닫았다가, 열어도 로그인이 유지된다.</p>\n<p>단, 다른 브라우저로 열거나 크롬의 시크릿모드로 열었을 땐, 로그인이 유지되지 않는다.<br>\n즉, 브라우저 어딘가에서 유저 정보를 저장하고 있는 것 같다.</p>\n<br/>\n<h2 id=\"3-1-로그인-했을-때-브라우저에-저장되는-정보\" style=\"position:relative;\"><a href=\"#3-1-%EB%A1%9C%EA%B7%B8%EC%9D%B8-%ED%96%88%EC%9D%84-%EB%95%8C-%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80%EC%97%90-%EC%A0%80%EC%9E%A5%EB%90%98%EB%8A%94-%EC%A0%95%EB%B3%B4\" aria-label=\"3 1 로그인 했을 때 브라우저에 저장되는 정보 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3-1. 로그인 했을 때 브라우저에 저장되는 정보</h2>\n<p>크게 로그인 정보는 <code class=\"language-text\">localStorage</code>나 <code class=\"language-text\">SessionStorage</code>, 또는 <code class=\"language-text\">cookie</code>에 저장할 수 있다.<br>\n구글 시크릿모드로 열어서, <strong>로그인 하기전에</strong> localStorage와 SessionStorage, cookie를 확인해보자.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dc7a9b1c5902eff00f4236ef2cd62392/89066/local-storage.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.1875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABVUlEQVQoz42Q3U7jMBCF8/5P1AWkveJmVRYu2CgrqnZLkobEjhP/tEnz9yGbgpDgYkf6dEZnPB6Po+3qBw+3ax5v79g8JFR/npCPMVkpybKCSiqOpzPWdbhjT6Mdh6KieKkoShE0P7yQH0pa7YiK3/esV1fcX/9kvbrh3687bCmxxxPWuoCx9pJbjFd3xDr3FeuItNH8TWJ22w0nZ5nGM/0w0rYtWusvtN94n4mUUux2O4SULMA8z3TdmbbVGGO+aTKBUHuvX9R7kXOOLMsoioI0TfED+n4Ih6zHr2lsUI/3zSfe6uZjeCSEIEkS4jhmv9/DstCfR4RQqEYjahWGCFlTVjJ4sm5QTUvTGupLXpYCYxyRXy1NM7Isp64VPiZApSXV0zP5Zkv6XFCJOvzrMAz0fR/U03XdhzdNE5G/yJPnh/BsH/MCyzgzuo6hH7CnkWnmv+IVrb1e7iX2O7UAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/dc7a9b1c5902eff00f4236ef2cd62392/a59e9/local-storage.webp 192w,\n/static/dc7a9b1c5902eff00f4236ef2cd62392/0ca9f/local-storage.webp 384w,\n/static/dc7a9b1c5902eff00f4236ef2cd62392/dc9b9/local-storage.webp 768w,\n/static/dc7a9b1c5902eff00f4236ef2cd62392/e2c2f/local-storage.webp 1152w,\n/static/dc7a9b1c5902eff00f4236ef2cd62392/95f20/local-storage.webp 1440w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/dc7a9b1c5902eff00f4236ef2cd62392/3b721/local-storage.png 192w,\n/static/dc7a9b1c5902eff00f4236ef2cd62392/66595/local-storage.png 384w,\n/static/dc7a9b1c5902eff00f4236ef2cd62392/fe486/local-storage.png 768w,\n/static/dc7a9b1c5902eff00f4236ef2cd62392/d2d74/local-storage.png 1152w,\n/static/dc7a9b1c5902eff00f4236ef2cd62392/89066/local-storage.png 1440w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/dc7a9b1c5902eff00f4236ef2cd62392/fe486/local-storage.png\"\n            alt=\"Local Storage\"\n            title=\"Local Storage\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Local Storage</figcaption>\n  </figure><br>\n<figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e2b3de320acb50e8b893d01ec4ff3940/89066/session-storage.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.1875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA80lEQVQoz5WRbUvDQBCE8///jwhCqPgGldL6wcYETSHpXSOmiTUGqeZuH0nTSJpQxYGBvdvbuRnWycOAeDomuZ/x+vSASSJs+Y4REBFsj8YKxtjBfUtHuS63oytm5zdMRtcs7jy2gQ/W0EDoQg6PAzjxxSXjkzMmpy7xdI6ezSnDxU5I9i5b1rCduttr6ayzNeFjwMvzClt98rX9oDK28SXy4+iY4MBhWZYorUmSBKUUeZ5jpX08HP5TME1TfN/H8zyiKELEYixUZr+Af9LZbN5YLhVKabIs3/1SN/pRf6sPHNZCNbVeURRFE8sOY/UXcWzj34+2bdzuVyqWAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/e2b3de320acb50e8b893d01ec4ff3940/a59e9/session-storage.webp 192w,\n/static/e2b3de320acb50e8b893d01ec4ff3940/0ca9f/session-storage.webp 384w,\n/static/e2b3de320acb50e8b893d01ec4ff3940/dc9b9/session-storage.webp 768w,\n/static/e2b3de320acb50e8b893d01ec4ff3940/e2c2f/session-storage.webp 1152w,\n/static/e2b3de320acb50e8b893d01ec4ff3940/95f20/session-storage.webp 1440w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/e2b3de320acb50e8b893d01ec4ff3940/3b721/session-storage.png 192w,\n/static/e2b3de320acb50e8b893d01ec4ff3940/66595/session-storage.png 384w,\n/static/e2b3de320acb50e8b893d01ec4ff3940/fe486/session-storage.png 768w,\n/static/e2b3de320acb50e8b893d01ec4ff3940/d2d74/session-storage.png 1152w,\n/static/e2b3de320acb50e8b893d01ec4ff3940/89066/session-storage.png 1440w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/e2b3de320acb50e8b893d01ec4ff3940/fe486/session-storage.png\"\n            alt=\"Session Storage\"\n            title=\"Session Storage\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Session Storage</figcaption>\n  </figure><br>\n<figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2d89f9bc6eb8b50454ec57960da3ef9e/89066/cookie.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.1875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABLElEQVQoz52Py04CQRBF+f8/0oUL40aNAlEHGc3oKAgMMN1V3fOSxzHdRnTjQis5ya1K163bPe89SZKQZRnOOUJZ1/KY5Tw9v7AuhfvxA5PpnNXaslwZktEYX7WURqnqjmJVYsVTrB09YyyBzWbLV1XtDlEf587XiDrUeeqmpapbVB1tt4m6e99S1Q1N22FdQ68oChaLBapKXdfs9zvEN1hRqsrH5ZA8IKqRqEXjofAu7AZWpdALIk1T8jyPeOdQ31Aai6rEBRGJBP3d66H/nCnLdTB0jvvRiIc05SXPUbFo1VEaiVdFfuen2cHQ9C8YnRzxen4Gs1eYZLinDBO/In83tKfHZIMrpsNr3m6HLO+G+P4l1tr/JdQs5e1mwCyYjRN28wluNsdY+VfCD2hsXZKmKiwLAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/2d89f9bc6eb8b50454ec57960da3ef9e/a59e9/cookie.webp 192w,\n/static/2d89f9bc6eb8b50454ec57960da3ef9e/0ca9f/cookie.webp 384w,\n/static/2d89f9bc6eb8b50454ec57960da3ef9e/dc9b9/cookie.webp 768w,\n/static/2d89f9bc6eb8b50454ec57960da3ef9e/e2c2f/cookie.webp 1152w,\n/static/2d89f9bc6eb8b50454ec57960da3ef9e/95f20/cookie.webp 1440w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/2d89f9bc6eb8b50454ec57960da3ef9e/3b721/cookie.png 192w,\n/static/2d89f9bc6eb8b50454ec57960da3ef9e/66595/cookie.png 384w,\n/static/2d89f9bc6eb8b50454ec57960da3ef9e/fe486/cookie.png 768w,\n/static/2d89f9bc6eb8b50454ec57960da3ef9e/d2d74/cookie.png 1152w,\n/static/2d89f9bc6eb8b50454ec57960da3ef9e/89066/cookie.png 1440w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/2d89f9bc6eb8b50454ec57960da3ef9e/fe486/cookie.png\"\n            alt=\"Cookie\"\n            title=\"Cookie\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Cookie</figcaption>\n  </figure></p>\n<p>Session Storage에는 아무것도 존재하지 않는다.<br>\n하지만 Local Storage와 Cookie에는 next-auth의 정보가 저장된다.</p>\n<h3 id=\"local-storage에-저장되는-정보\" style=\"position:relative;\"><a href=\"#local-storage%EC%97%90-%EC%A0%80%EC%9E%A5%EB%90%98%EB%8A%94-%EC%A0%95%EB%B3%B4\" aria-label=\"local storage에 저장되는 정보 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Local Storage에 저장되는 정보</h3>\n<p>먼저, LocalStorage에는 정보가 저장될거라 예상못했는데, 확인해보자.<br>\n자세히 보니, <code class=\"language-text\">getSession</code>이라는 단어가 가장 먼저 눈에 띄었다.<br>\nnext-auth에서 <a href=\"https://next-auth.js.org/getting-started/client#getsession\" target=\"_blank\" rel=\"nofollow\">getSession</a>이라는 API를 제공하는데 그 역할이 무엇인지 확인해봤다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">When called, getSession() will send a request to /api/auth/session\nand returns a promise with a session object, or null if no session exists.\n\n호출되면 getSession()은 /api/auth/session으로 요청을 보내고\n세션 객체가 있는 프로미스를 반환하거나 세션이 존재하지 않는 경우 null을 반환합니다.</code></pre></div>\n<p>세션정보를 요청하고, 세션객체가 있다면 세션에 담긴 정보를, 세션이 없다면 null을 반환하는 걸로 보인다.</p>\n<br/>\n<p>그 다음엔 어떻게 했을 때, localStorage에 이 정보가 저장되는지 확인해봤다.<br>\nnext-auth를 사용하기 위해선, 다음과 같이 SessionProvider를 감싸줘야한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token string\">'use client'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> SessionProvider <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next-auth/react'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">Props</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  children<span class=\"token operator\">:</span> React<span class=\"token punctuation\">.</span>ReactNode<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> AuthContext<span class=\"token operator\">:</span> React<span class=\"token punctuation\">.</span><span class=\"token constant\">FC</span><span class=\"token operator\">&lt;</span>Props<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> children <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SessionProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">SessionProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>SessionProvider로 감싸줘야, useSession hook을 클라이언트 환경에서 사용할 수 있기 때문이다.<br>\n(참고로, 서버에서 사용하려면, <a href=\"https://next-auth.js.org/configuration/nextjs#getserversession\" target=\"_blank\" rel=\"nofollow\">getServerSession</a>을 사용한다.)</p>\n<br/>\n<p>근데 이 provider를 감싸지 않으니, localStorage에 더 이상 정보가 저장되지 않았다.<br>\n그래서 <a href=\"https://github.com/nextauthjs/next-auth/blob/a595ca72595b2bd350b23068f9e437726cef9a9d/packages/next-auth/src/react.tsx#L337\" target=\"_blank\" rel=\"nofollow\">SessionProvider 내부</a>를 한 번 확인해봤다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getSession</span><span class=\"token punctuation\">(</span>params<span class=\"token operator\">?</span><span class=\"token operator\">:</span> GetSessionParams<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> session <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token generic-function\"><span class=\"token function\">fetchData</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Session<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"session\"</span><span class=\"token punctuation\">,</span>\n    __NEXTAUTH<span class=\"token punctuation\">,</span>\n    logger<span class=\"token punctuation\">,</span>\n    params\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>params<span class=\"token operator\">?.</span>broadcast <span class=\"token operator\">??</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">broadcast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token comment\">// broadcast???</span>\n      event<span class=\"token operator\">:</span> <span class=\"token string\">\"session\"</span><span class=\"token punctuation\">,</span>\n      data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> trigger<span class=\"token operator\">:</span> <span class=\"token string\">\"getSession\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> session\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>SessionProvider 내부에 getSession이 존재하고, getSession에서 broadcast가 존재한다.<br>\n이 broadcast를 찾아보니, localStorage에 저장하는 로직을 발견했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// node_modules/next-auth/src/client/_utils.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">BroadcastChannel</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"nextauth.message\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/** Get notified by other tabs/windows. */</span>\n    <span class=\"token function\">receive</span><span class=\"token punctuation\">(</span><span class=\"token function-variable function\">onReceive</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>message<span class=\"token operator\">:</span> BroadcastMessage<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>event<span class=\"token operator\">:</span> StorageEvent<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>key <span class=\"token operator\">!==</span> name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n        <span class=\"token keyword\">const</span> message<span class=\"token operator\">:</span> BroadcastMessage <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>newValue <span class=\"token operator\">??</span> <span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>message<span class=\"token operator\">?.</span>event <span class=\"token operator\">!==</span> <span class=\"token string\">\"session\"</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>message<span class=\"token operator\">?.</span>data<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n\n        <span class=\"token function\">onReceive</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n      window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"storage\"</span><span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> window<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"storage\"</span><span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">/** Notify other tabs/windows. */</span>\n    <span class=\"token function\">post</span><span class=\"token punctuation\">(</span>message<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">unknown</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> window <span class=\"token operator\">===</span> <span class=\"token string\">\"undefined\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        localStorage<span class=\"token punctuation\">.</span><span class=\"token function\">setItem</span><span class=\"token punctuation\">(</span> <span class=\"token comment\">// 이 부분</span>\n          name<span class=\"token punctuation\">,</span>\n          <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>message<span class=\"token punctuation\">,</span> timestamp<span class=\"token operator\">:</span> <span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">/**\n         * The localStorage API isn't always available.\n         * It won't work in private mode prior to Safari 11 for example.\n         * Notifications are simply dropped if an error is encountered.\n         */</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>즉, 정리해보면</p>\n<blockquote>\n<p>localStorage에 저장되는 정보는, session의 상태가 변경될 때마다, broadcast를 통해 localStorage에 저장한다.<br>\n그리고 다른 탭이나, 윈도우에서도 localStorage에 저장된 정보를 받아서, 세션 정보를 업데이트한다.</p>\n</blockquote>\n<br/>\n<h3 id=\"cookie에-저장되는-정보\" style=\"position:relative;\"><a href=\"#cookie%EC%97%90-%EC%A0%80%EC%9E%A5%EB%90%98%EB%8A%94-%EC%A0%95%EB%B3%B4\" aria-label=\"cookie에 저장되는 정보 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cookie에 저장되는 정보</h3>\n<p>다음으로, Cookie에 저장되는 정보를 확인해보자.<br>\n이번엔 <strong>로그인을 한 후에</strong> 확인해보자.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2f70140e00371fc2e9f3db92107982cf/4ab23/saved-cookie.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 12.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAr0lEQVQI1x2N0XKDIBBF/f+fq02TtjPtdKoEiYJEAUHU9HTCvuzeO2fOVks6CGknxI3Jr/y2HX7JhLjT3UaM9UilS//90yJkjx4dUpmyh3Gm1xPaupKr8/mduj5xlQrnI6e3Cy/1K9pYmlZi7468Pfj4/OIqO1yILGlDqh4fEn9QmCf/nErdhiKLKRPXDSEkTSMwdmIwtjxZ80ErJNPsi2DNO/fZs8TM8aAwswvl/gcDmOKpZOxSlAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/2f70140e00371fc2e9f3db92107982cf/a59e9/saved-cookie.webp 192w,\n/static/2f70140e00371fc2e9f3db92107982cf/0ca9f/saved-cookie.webp 384w,\n/static/2f70140e00371fc2e9f3db92107982cf/dc9b9/saved-cookie.webp 768w,\n/static/2f70140e00371fc2e9f3db92107982cf/e2c2f/saved-cookie.webp 1152w,\n/static/2f70140e00371fc2e9f3db92107982cf/13d4d/saved-cookie.webp 1462w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/2f70140e00371fc2e9f3db92107982cf/3b721/saved-cookie.png 192w,\n/static/2f70140e00371fc2e9f3db92107982cf/66595/saved-cookie.png 384w,\n/static/2f70140e00371fc2e9f3db92107982cf/fe486/saved-cookie.png 768w,\n/static/2f70140e00371fc2e9f3db92107982cf/d2d74/saved-cookie.png 1152w,\n/static/2f70140e00371fc2e9f3db92107982cf/4ab23/saved-cookie.png 1462w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/2f70140e00371fc2e9f3db92107982cf/fe486/saved-cookie.png\"\n            alt=\"cookie에 저장된 정보들\"\n            title=\"cookie에 저장된 정보들\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">cookie에 저장된 정보들</figcaption>\n  </figure></p>\n<p><strong>💬 <code class=\"language-text\">next-auth.callback-url</code>은 인증을 완료한 뒤, 리다이렉트할 url이다.</strong><br>\n예를들어, 로그인을 하고, <code class=\"language-text\">/posts</code>로 리다이렉트하고 싶다면, 다음과 같이 설정하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// app/page.tsx</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">Home</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//...</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>p-4<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token punctuation\">{</span>session <span class=\"token operator\">?</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">환영합니다, </span><span class=\"token punctuation\">{</span>session<span class=\"token punctuation\">.</span>user<span class=\"token operator\">?.</span>name<span class=\"token punctuation\">}</span><span class=\"token plain-text\">!</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          //...\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">로그인을 해주세요.</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span>\n            <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n              <span class=\"token function\">signIn</span><span class=\"token punctuation\">(</span><span class=\"token string\">'google'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n                callbackUrl<span class=\"token operator\">:</span> <span class=\"token string\">'http://localhost:3000/posts'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// callbackUrl 설정</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span></span>\n          <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            Google로 로그인하기\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>callbackUrl을 지정하고 로그인이 완료되면, 쿠키에 다음과 같이 저장된다.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fd364df417af607d3d5b2d57b3d9493f/5040b/cookie-callback-url.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.60416666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABWElEQVQoz42Q3U7CQBCF+/6P5I3RaNQLNcYftIBYipRSurttaaHQnc9YCm1MVDY5mdkzZ2fOjjOZzgkjTTBX6LRg8D7mm1Mmx/MDojhl5E157vUZfkyYxwmePyNSGeHCMA1jYpMThIokK3HuXzxun0Y89Hw+4y2PbsD1nYvraV5HCwJt6fuGR3dKoKpa0x+bmp8ZYeAbogxcTzEOVzgLZYhVgk4yyq2gTEYUa0yao5Mlq7IiSQtinbCpqO9Zvq7juqmVGyHNCpbFBofOEZE2b6K10uYiWNnVal7kkH+fyoJTkwe0QitttJ26yI+6bYaIUFnZOdw5a4V7N92He91Pvjuwadg8kG5D+bWh/NdQaL7ScfCXQznGYbOcDuxhyH6nRzfU/R7L4Rv5u0s2eCNxXyi8IXb4SrUuqYRaeAy2leCENxdEV2fMG8wuTwmvz8nPT2C9OqziWHwBFWhXJIpJblwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/fd364df417af607d3d5b2d57b3d9493f/a59e9/cookie-callback-url.webp 192w,\n/static/fd364df417af607d3d5b2d57b3d9493f/0ca9f/cookie-callback-url.webp 384w,\n/static/fd364df417af607d3d5b2d57b3d9493f/dc9b9/cookie-callback-url.webp 768w,\n/static/fd364df417af607d3d5b2d57b3d9493f/e2c2f/cookie-callback-url.webp 1152w,\n/static/fd364df417af607d3d5b2d57b3d9493f/55fcb/cookie-callback-url.webp 1468w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/fd364df417af607d3d5b2d57b3d9493f/3b721/cookie-callback-url.png 192w,\n/static/fd364df417af607d3d5b2d57b3d9493f/66595/cookie-callback-url.png 384w,\n/static/fd364df417af607d3d5b2d57b3d9493f/fe486/cookie-callback-url.png 768w,\n/static/fd364df417af607d3d5b2d57b3d9493f/d2d74/cookie-callback-url.png 1152w,\n/static/fd364df417af607d3d5b2d57b3d9493f/5040b/cookie-callback-url.png 1468w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/fd364df417af607d3d5b2d57b3d9493f/fe486/cookie-callback-url.png\"\n            alt=\"encode → decode해보면, localhost:3000/posts가 저장되어 있음\"\n            title=\"encode → decode해보면, localhost:3000/posts가 저장되어 있음\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">encode → decode해보면, localhost:3000/posts가 저장되어 있음</figcaption>\n  </figure></p>\n<br/>\n<p><strong>💬 그럼, <code class=\"language-text\">next-auth.csrf-token</code>는 무엇일까?</strong><br>\n이 부분은 설명이 너무 길어질 것 같아서, <a href=\"https://youtu.be/cUmIB2sjjdw?si=btICVO6EFSewEf5M\" target=\"_blank\" rel=\"nofollow\">다른 영상</a>로 대체하려 한다.<br>\n간략히, 보안을 강화하기 위해 하나의 검증수단으로 token을 더 두는 것이다.</p>\n<p>참고로, 나는 따로 설정을 해주진 않았다.<br>\n<code class=\"language-text\">4-1. 주의할 점</code>에서도 설명하겠지만, 이 예시에선 서버와 클라이언트 도메인이 일치하기에 sameSite로 인해<br>\nCSRF를 방지할 수 있다고 판단했다.</p>\n<br/>\n<p><strong>💬 그럼 마지막으로 <code class=\"language-text\">next-auth.session-token</code>은 무엇일까?</strong><br>\nnext-auth로 로그인을 하면, JWT을 사용하여 세션을 만들 수 있다.<br>\n즉, 사용자가 로그인하면 HttpOnly 쿠키에 JWT가 생성된다.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6c3ea4f39507260110bfd71bc6a47007/4ab23/next-auth-session-tokne.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.895833333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABzklEQVQoz62RO3PaQBSF9f+r9OlTp0kKp3AA2wHzCMbYmKd4CmxA2l09VgJPvoxWEsZxm+Kbe+45Z3c1I6vTdxjNXSZLge0obMen1bWZbXwGM5fe5IUne0e9M6bRmTCcezyMNmam9Kc7xitluosXjbXYKDqPNr+7Y4bTZ57dmNb9iE5vynTlMVsLdvKVbn+Osw1wgz/M15L1XiMimDkCN8B4zjbE8oMQ1/NwXY8wjIjjA3vXwxMCqXzSPE4O7PcucZJwPL4ShhodJxwOR3w/JEmOBGFEpDWWOeSnBCjlI6QyOvXSTOae8gOkUkZLmXlG53k6lVJYWUGe8e8uKTpKZXm2q1zLk0475sKimL5QhOdanLzzwx85feH/vVBIZPoDckShZTpl7mVTyaInT9mblighsJRO8LVGRQUxvo5RoUaGEdLMTKt3+0fSu6xdq8623UQ83OF127j3bfZ3LaJBj3jcJxr20KOn9wwzouHbHo366E4T6/HiG7ValdurCrVKmZvST25Kl1QrZcOvconb6yvqN9dmL/Q51dIllWqNwedPWL0f32k1Gjy0mmzmM5ypzfNywWpqs7InZi7tiSHN13nHyXPj2WNWL1vcr1/4C5ZAfiWiURbFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/6c3ea4f39507260110bfd71bc6a47007/a59e9/next-auth-session-tokne.webp 192w,\n/static/6c3ea4f39507260110bfd71bc6a47007/0ca9f/next-auth-session-tokne.webp 384w,\n/static/6c3ea4f39507260110bfd71bc6a47007/dc9b9/next-auth-session-tokne.webp 768w,\n/static/6c3ea4f39507260110bfd71bc6a47007/e2c2f/next-auth-session-tokne.webp 1152w,\n/static/6c3ea4f39507260110bfd71bc6a47007/13d4d/next-auth-session-tokne.webp 1462w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/6c3ea4f39507260110bfd71bc6a47007/3b721/next-auth-session-tokne.png 192w,\n/static/6c3ea4f39507260110bfd71bc6a47007/66595/next-auth-session-tokne.png 384w,\n/static/6c3ea4f39507260110bfd71bc6a47007/fe486/next-auth-session-tokne.png 768w,\n/static/6c3ea4f39507260110bfd71bc6a47007/d2d74/next-auth-session-tokne.png 1152w,\n/static/6c3ea4f39507260110bfd71bc6a47007/4ab23/next-auth-session-tokne.png 1462w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/6c3ea4f39507260110bfd71bc6a47007/fe486/next-auth-session-tokne.png\"\n            alt=\"생성된 JWT 토큰\"\n            title=\"생성된 JWT 토큰\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">생성된 JWT 토큰</figcaption>\n  </figure></p>\n<p>이 쿠키는 HttpOnly로 만들어져 클라이언트에서 JS로 접근할 수 없다.<br>\n또한, 이 JWT는 Secret키로 암호화되어있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// app/api/auth/[...nextauth].ts</span>\n<span class=\"token keyword\">const</span> handler <span class=\"token operator\">=</span> <span class=\"token function\">NextAuth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  secret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NEXTAUTH_SECRET</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 여기 Secret Key</span>\n  providers<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token function\">GoogleProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      clientId<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">GOOGLE_CLIENT_ID</span> <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n      clientSecret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">GOOGLE_CLIENT_SECRET</span> <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  session<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    strategy<span class=\"token operator\">:</span> <span class=\"token string\">'jwt'</span><span class=\"token punctuation\">,</span>\n    maxAge<span class=\"token operator\">:</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span> <span class=\"token operator\">*</span> <span class=\"token number\">30</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 30 days</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>사용자가 로그아웃하면 쿠키에서 JWT가 삭제되고, 세션을 없애준다.</p>\n<br/>\n<p><strong>💬 근데, 아까부터 나오던 session이란건 뭘까?</strong><br>\nnext-auth에서 제시하는 session이란 한 문장으로 다음과 같다.</p>\n<blockquote>\n<p>‘사용자가 애플리케이션에 로그인하면 일정시간동안 로그인할 필요가 없도록 사용자 정보 저장방법’<br>\nnext-auth에선 세션으로 크게 <a href=\"https://authjs.dev/concepts/session-strategies\" target=\"_blank\" rel=\"nofollow\">두 가지 전략</a>을 제시하고 있다.<br>\n(위에서 언급했던 JWT, Database)</p>\n</blockquote>\n<br/>\n<h2 id=\"3-2-next-auth-인증을-유지하는-방법\" style=\"position:relative;\"><a href=\"#3-2-next-auth-%EC%9D%B8%EC%A6%9D%EC%9D%84-%EC%9C%A0%EC%A7%80%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95\" aria-label=\"3 2 next auth 인증을 유지하는 방법 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3-2. next-auth 인증을 유지하는 방법</h2>\n<p>정리해보면, next-auth에서 인증을 유지하는 방법은, 두 가지가 있다. (JWT, DB)<br>\n이 중, JWT로 인증을 유지하는 방법은, cookie에 저장된 정보(=<code class=\"language-text\">next-auth.session-token</code>)를 통해 유지한다.</p>\n<p>그리고 secret key로 암호화되어있기 때문에, 클라이언트에서는 접근할 수 없다.<br>\n만약 만료시간이 끝났을 경우, 다시 로그인을 해야한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> handler <span class=\"token operator\">=</span> <span class=\"token function\">NextAuth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  secret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NEXTAUTH_SECRET</span><span class=\"token punctuation\">,</span>\n  providers<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token function\">GoogleProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      clientId<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">GOOGLE_CLIENT_ID</span> <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n      clientSecret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">GOOGLE_CLIENT_SECRET</span> <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  session<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    strategy<span class=\"token operator\">:</span> <span class=\"token string\">'jwt'</span><span class=\"token punctuation\">,</span>\n    maxAge<span class=\"token operator\">:</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// default 30일 -> 10초로 변경</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위와 같이, JWT maxAge를 10초로 변경했을 경우, 로그인 이후 10초 뒤 로그아웃되고,<br>\ncookie에 <code class=\"language-text\">next-auth.session-token</code>는 삭제된다.</p>\n<br/>\n<h1 id=\"4-next-auth의-인가는-어떻게-이루어질까\" style=\"position:relative;\"><a href=\"#4-next-auth%EC%9D%98-%EC%9D%B8%EA%B0%80%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%9D%B4%EB%A3%A8%EC%96%B4%EC%A7%88%EA%B9%8C\" aria-label=\"4 next auth의 인가는 어떻게 이루어질까 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. next-auth의 인가는 어떻게 이루어질까?</h1>\n<p>이제 인가에 대해서 알아보자.\n간단하게, api를 하나 만들어보자</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// app/api/posts.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> NextRequest<span class=\"token punctuation\">,</span> NextResponse <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next/server'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> getToken <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next-auth/jwt'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> posts <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token comment\">//mocking...</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token constant\">GET</span><span class=\"token punctuation\">(</span>request<span class=\"token operator\">:</span> NextRequest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> req<span class=\"token operator\">:</span> request<span class=\"token punctuation\">,</span> secret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SECRET</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'token'</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// log를 확인</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> NextResponse<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>posts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> NextResponse<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">{</span> message<span class=\"token operator\">:</span> <span class=\"token string\">'Token을 확인해주세요.'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span> status<span class=\"token operator\">:</span> <span class=\"token number\">401</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>로그인을 해서 cookie에 정보가 잘 저장됐다면,<br>\nnext-auth에서 제공하는 <a href=\"https://next-auth.js.org/tutorials/securing-pages-and-api-routes#using-gettoken\" target=\"_blank\" rel=\"nofollow\">getToken</a> API를 사용해, 암호화된 쿠키 내 유저정보를 복호화할 수 있다.</p>\n<br/>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// app/pages.tsx</span>\n<span class=\"token string\">'use client'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> signIn<span class=\"token punctuation\">,</span> signOut<span class=\"token punctuation\">,</span> useSession <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'next-auth/react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useState <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">Home</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data<span class=\"token operator\">:</span> session <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useSession</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>posts<span class=\"token punctuation\">,</span> setPosts<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">fetchPosts</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/posts'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>res<span class=\"token punctuation\">.</span>ok<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'posts를 불러오는데 실패했어요!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">setPosts</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">renderSessionInfo</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>pre</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>overflow-auto bg-gray-100 p-4<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token punctuation\">{</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>pre</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>p-4<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token punctuation\">{</span>session <span class=\"token operator\">?</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">환영합니다, </span><span class=\"token punctuation\">{</span>session<span class=\"token punctuation\">.</span>user<span class=\"token operator\">?.</span>name<span class=\"token punctuation\">}</span><span class=\"token plain-text\">!</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">signOut</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">로그아웃</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>mt-4 border border-black<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span><span class=\"token function\">renderSessionInfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>fetchPosts<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Fetch Posts</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"> // 로그인 했을 때, posts를 불러오면?\n          </span><span class=\"token punctuation\">{</span>posts <span class=\"token operator\">&amp;&amp;</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>posts<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">로그인을 해주세요.</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">signIn</span><span class=\"token punctuation\">(</span><span class=\"token string\">'google'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Google로 로그인하기</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>fetchPosts<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Fetch Posts</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"> // 로그인 안했을 때, posts를 불러오면?\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d7cbc799938ea69de17c73a23883b4d7/34cf9/fail-fetch.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 9.895833333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAc0lEQVQI123GywrCMBQA0f7/bylmW2oQBBdNLZTaZpFHU7W5GUHFlYvDTLVXit1BUR/1f1pTNw3mdObWDbSXgbGfWeeJu7WID5Tg8ZPDjo6qNYbu2uNjJKZEXNKn31/SigsB7xzkje3xRHKGUt6KyI9k4QXxE5WHQhsl8QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/d7cbc799938ea69de17c73a23883b4d7/a59e9/fail-fetch.webp 192w,\n/static/d7cbc799938ea69de17c73a23883b4d7/0ca9f/fail-fetch.webp 384w,\n/static/d7cbc799938ea69de17c73a23883b4d7/dc9b9/fail-fetch.webp 768w,\n/static/d7cbc799938ea69de17c73a23883b4d7/e2c2f/fail-fetch.webp 1152w,\n/static/d7cbc799938ea69de17c73a23883b4d7/f3efb/fail-fetch.webp 1536w,\n/static/d7cbc799938ea69de17c73a23883b4d7/c8d93/fail-fetch.webp 2858w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/d7cbc799938ea69de17c73a23883b4d7/3b721/fail-fetch.png 192w,\n/static/d7cbc799938ea69de17c73a23883b4d7/66595/fail-fetch.png 384w,\n/static/d7cbc799938ea69de17c73a23883b4d7/fe486/fail-fetch.png 768w,\n/static/d7cbc799938ea69de17c73a23883b4d7/d2d74/fail-fetch.png 1152w,\n/static/d7cbc799938ea69de17c73a23883b4d7/e8464/fail-fetch.png 1536w,\n/static/d7cbc799938ea69de17c73a23883b4d7/34cf9/fail-fetch.png 2858w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/d7cbc799938ea69de17c73a23883b4d7/fe486/fail-fetch.png\"\n            alt=\"당연하겠지만, 로그인 하지 않은 상태에선 요청이 실패한다.\"\n            title=\"당연하겠지만, 로그인 하지 않은 상태에선 요청이 실패한다.\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">당연하겠지만, 로그인 하지 않은 상태에선 요청이 실패한다.</figcaption>\n  </figure><br>\ncookie에 저장된 token이 없으니, 요청을 보내도 데이터를 반환하지 않고 Error를 던진다.</p>\n<br/>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e27497a0d2523095cbb03f1e11f90288/31384/success-token.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.770833333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABEUlEQVQY03WQ23KCMBRF+ZSOVHsDAbFAKORiAOWmTDu1jk7L9P8/YncSVNqHPqw5J5lk56wYJKvAyw5eyuELjrtFDNMOYc7Dsf7GDjE5Y9rjWtVbJ4Thvqyw+/gCyQrUnw3y9wqbQ418X4J3a5B1BiehGi+l8DnHcjU8vmAMPmd6T/UWSWAEUqI5vqI67lAcamy/t2j7FtWpAdlIeJTpw25Kda/CAimGUBUuRnTgnDDEskTRCOxPJWSbwzlP8hQmuHkMrlzUJtao+UdfKduR0H/YvWXo+wqilJgnVKuoqbQaZ3qCh+cYM4/8y9SLYERcwAoorDiFQxnsOB2COL9qqqq075cxpm40XHbHEMXMHQJ/AL95x+r+RhuMAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/e27497a0d2523095cbb03f1e11f90288/a59e9/success-token.webp 192w,\n/static/e27497a0d2523095cbb03f1e11f90288/0ca9f/success-token.webp 384w,\n/static/e27497a0d2523095cbb03f1e11f90288/dc9b9/success-token.webp 768w,\n/static/e27497a0d2523095cbb03f1e11f90288/91b06/success-token.webp 976w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/e27497a0d2523095cbb03f1e11f90288/3b721/success-token.png 192w,\n/static/e27497a0d2523095cbb03f1e11f90288/66595/success-token.png 384w,\n/static/e27497a0d2523095cbb03f1e11f90288/fe486/success-token.png 768w,\n/static/e27497a0d2523095cbb03f1e11f90288/31384/success-token.png 976w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/e27497a0d2523095cbb03f1e11f90288/fe486/success-token.png\"\n            alt=\"쿠키를 복호화해 유저의 정보를 얻을 수 있다.\"\n            title=\"쿠키를 복호화해 유저의 정보를 얻을 수 있다.\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">쿠키를 복호화해 유저의 정보를 얻을 수 있다.</figcaption>\n  </figure></p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\">  <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> req<span class=\"token operator\">:</span> request<span class=\"token punctuation\">,</span> secret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SECRET</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'token'</span><span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// log를 확인</span></code></pre></div>\n<p>getToken에 인자로 포함된 secret와 cookie를 통해 유저 정보를 복호화할 수 있다.</p>\n<br/>\n<h3 id=\"4-1-주의할-점\" style=\"position:relative;\"><a href=\"#4-1-%EC%A3%BC%EC%9D%98%ED%95%A0-%EC%A0%90\" aria-label=\"4 1 주의할 점 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4-1. 주의할 점</h3>\n<blockquote>\n<p>몇 달전, 위와 같이 잘 되는걸 확인하고 즐거운 마음으로 퇴근했었다.<br>\n하지만, 다음 날 절망했다.. 😩</p>\n</blockquote>\n<p>만약 클라이언트와 서버가 도메인이 각각 다르다면 추가적인 설정이 필요하다.<br>\n관련 내용은 <a href=\"https://seob.dev/posts/%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80-%EC%BF%A0%ED%82%A4%EC%99%80-SameSite-%EC%86%8D%EC%84%B1/\" target=\"_blank\" rel=\"nofollow\">이 글</a>에서 잘 설명해주신다.</p>\n<p>간략히 정리해보자면,</p>\n<blockquote>\n<p>쿠키로 인증을 하는 경우, csrf 공격에 취약하다.<br>\n그래서 이를 방지하기 위해 <a href=\"https://seob.dev/posts/%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80-%EC%BF%A0%ED%82%A4%EC%99%80-SameSite-%EC%86%8D%EC%84%B1/#samesite-%EC%BF%A0%ED%82%A4\" target=\"_blank\" rel=\"nofollow\">SameSite</a>가 만들어졌다.</p>\n<p>next-auth를 사용하는데, 클라이언트와 서버의 도메인이 각각 다르다면,<br>\n<a href=\"https://next-auth.js.org/configuration/options#cookies\" target=\"_blank\" rel=\"nofollow\">추가적인 설정</a>이 필요하다.</p>\n</blockquote>\n<p>이번의 예시에선, next-auth를 next.js에서만 사용했고,<br>\n배포를 해도 동일한 도메인이기에 문제없이 잘 동작했다. 🍀</p>\n<br/>\n<h3 id=\"참고자료\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0%EC%9E%90%EB%A3%8C\" aria-label=\"참고자료 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참고자료</h3>\n<ul>\n<li>\n<p>next-auth<br>\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Broadcast_Channel_API\" target=\"_blank\" rel=\"nofollow\">Broadcast Channel API</a><br>\n<a href=\"https://authjs.dev/concepts/session-strategies\" target=\"_blank\" rel=\"nofollow\">next-auth Session strategies</a></p>\n</li>\n<li>\n<p>cookie<br>\n<a href=\"https://seob.dev/posts/%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80-%EC%BF%A0%ED%82%A4%EC%99%80-SameSite-%EC%86%8D%EC%84%B1/\" target=\"_blank\" rel=\"nofollow\">브라우저 쿠키와 SameSite 속성</a></p>\n</li>\n<li>\n<p>csrf<br>\n<a href=\"https://blog.logrocket.com/protecting-next-js-apps-csrf-attacks/\" target=\"_blank\" rel=\"nofollow\">Protecting Next.js apps from CSRF attacks</a><br>\n<a href=\"https://www.youtube.com/watch?v=cUmIB2sjjdw\" target=\"_blank\" rel=\"nofollow\">링크만 클릭했는데 이게 된다고? | 웹 해킹 CSRF 공격 | CSRF 공격 이렇게 한다!</a></p>\n</li>\n</ul>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#1-token%EC%9D%98-%ED%95%84%EC%9A%94%EC%84%B1\">1. Token의 필요성</a></p>\n</li>\n<li>\n<p><a href=\"#2-next-auth-token-%EA%B4%80%EB%A6%AC-%EB%B0%A9%EB%B2%95\">2. next-auth Token 관리 방법</a></p>\n<ul>\n<li><a href=\"#2-1-%EC%9D%B8%EC%A6%9Dauthentication%EA%B3%BC-%EC%9D%B8%EA%B0%80authorization%EA%B0%80-%EB%AD%98%EA%B9%8C\">2-1. 인증(Authentication)과 인가(Authorization)가 뭘까?</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#3-next-auth%EB%8A%94-%EC%9D%B8%EC%A6%9D%EC%9D%84-%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%9C%A0%EC%A7%80%ED%95%A0%EA%B9%8C\">3. next-auth는 인증을 어떻게 유지할까?</a></p>\n<ul>\n<li>\n<p><a href=\"#3-1-%EB%A1%9C%EA%B7%B8%EC%9D%B8-%ED%96%88%EC%9D%84-%EB%95%8C-%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80%EC%97%90-%EC%A0%80%EC%9E%A5%EB%90%98%EB%8A%94-%EC%A0%95%EB%B3%B4\">3-1. 로그인 했을 때 브라우저에 저장되는 정보</a></p>\n<ul>\n<li><a href=\"#local-storage%EC%97%90-%EC%A0%80%EC%9E%A5%EB%90%98%EB%8A%94-%EC%A0%95%EB%B3%B4\">Local Storage에 저장되는 정보</a></li>\n<li><a href=\"#cookie%EC%97%90-%EC%A0%80%EC%9E%A5%EB%90%98%EB%8A%94-%EC%A0%95%EB%B3%B4\">Cookie에 저장되는 정보</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#3-2-next-auth-%EC%9D%B8%EC%A6%9D%EC%9D%84-%EC%9C%A0%EC%A7%80%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95\">3-2. next-auth 인증을 유지하는 방법</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#4-next-auth%EC%9D%98-%EC%9D%B8%EA%B0%80%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%9D%B4%EB%A3%A8%EC%96%B4%EC%A7%88%EA%B9%8C\">4. next-auth의 인가는 어떻게 이루어질까?</a></p>\n<ul>\n<li>\n<ul>\n<li><a href=\"#4-1-%EC%A3%BC%EC%9D%98%ED%95%A0-%EC%A0%90\">4-1. 주의할 점</a></li>\n<li><a href=\"#%EC%B0%B8%EA%B3%A0%EC%9E%90%EB%A3%8C\">참고자료</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>","frontmatter":{"title":"next-auth를 활용한 인증 및 인가 이해하기","summary":"토큰을 데이터베이스에 저장하지 않고 인증 및 인가 처리 구현하기","date":"2024.01.21.","categories":["개발"]}}}]}},"pageContext":{"slug":"/blog/2024/1/17/authorization/"}},"staticQueryHashes":["1629908903"]}
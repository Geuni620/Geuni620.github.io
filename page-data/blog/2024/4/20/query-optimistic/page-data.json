{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/2024/4/20/query-optimistic/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<p><a href=\"https://github.com/Geuni620/tanstack-query-optimistic-updates\" target=\"_blank\" rel=\"nofollow\">github repo</a></p>\n<blockquote>\n<p><a href=\"https://tanstack.com/query/latest/docs/framework/react/guides/optimistic-updates\" target=\"_blank\" rel=\"nofollow\">공식문서</a>에 적혀 있는 두 가지 예시를 모두 구현해보자.</p>\n</blockquote>\n<br/>\n<h3 id=\"낙관적-업데이트optimistic-updates는-어떨-때-사용할까\" style=\"position:relative;\"><a href=\"#%EB%82%99%EA%B4%80%EC%A0%81-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8optimistic-updates%EB%8A%94-%EC%96%B4%EB%96%A8-%EB%95%8C-%EC%82%AC%EC%9A%A9%ED%95%A0%EA%B9%8C\" aria-label=\"낙관적 업데이트optimistic updates는 어떨 때 사용할까 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>낙관적 업데이트(Optimistic updates)는 어떨 때 사용할까?</h3>\n<p>낙관적 업데이트는 한 마디로,<br>\n데이터를 변경하려 할 때, <strong>응답을 기다리기 전 미리 UI를 업데이트 시키는 것</strong>이다.</p>\n<br/>\n<p>다음과 같은 상황에 쓰려고 했다.</p>\n<ul>\n<li>체크박스가 존재한다.</li>\n<li>체크박스를 클릭하자마자 DB에 해당 체크박스의 변경된 정보를 저장한다.</li>\n</ul>\n<p>간단히 예시를 만들어보자.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ad7deb0fb5251775bde96d2f37ccf18a/f537a/detail-ui.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAABbklEQVQ4y6WSXUvDMBiF8z+98g/4kwQFBUVEr7wVBdELccw5x+jWz3Rzq22TtUnXryPJtAzZdGMvPLzJS3LgJIdMpwHar10YAxOW7YD6I6iq6/pfVEkpEUUx4piBMQ7SandxeHyOo5ML3N4/biy2LLpcRKn3+gaGpo3PMNpa8DdESIkwjCCE1GJlWaKsqpVUG0CCkOHh+Q29/gB9w0SaSiRrmCViLXyWQsgMRB106QRDy4UxtOH5Y1D/A643gkvHunt0MWM8aS6vQogMpChLZNkcqZB6yPhME7MZOE90/1lLmUFm89XIOeZ5DjIJItw9tfHeM7TlZFfLMssxCWItNjAdmLan7Vu2p9eqWw7V3XboWruMp9olUb/LlU3GkaYCRVFCPYP6bdX1/nv2J8UiHSSKGRzXB/XHmAbhThnUOVxOeV4UTfq3FVKlc9juvOP07AoeHTXDqqpR1VtQLUTVM5HL6xvs7R/gpdVpBHepLz9jOTy8HXSEAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/ad7deb0fb5251775bde96d2f37ccf18a/a59e9/detail-ui.webp 192w,\n/static/ad7deb0fb5251775bde96d2f37ccf18a/0ca9f/detail-ui.webp 384w,\n/static/ad7deb0fb5251775bde96d2f37ccf18a/dc9b9/detail-ui.webp 768w,\n/static/ad7deb0fb5251775bde96d2f37ccf18a/e2c2f/detail-ui.webp 1152w,\n/static/ad7deb0fb5251775bde96d2f37ccf18a/f3efb/detail-ui.webp 1536w,\n/static/ad7deb0fb5251775bde96d2f37ccf18a/c7f2d/detail-ui.webp 1730w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/ad7deb0fb5251775bde96d2f37ccf18a/3b721/detail-ui.png 192w,\n/static/ad7deb0fb5251775bde96d2f37ccf18a/66595/detail-ui.png 384w,\n/static/ad7deb0fb5251775bde96d2f37ccf18a/fe486/detail-ui.png 768w,\n/static/ad7deb0fb5251775bde96d2f37ccf18a/d2d74/detail-ui.png 1152w,\n/static/ad7deb0fb5251775bde96d2f37ccf18a/e8464/detail-ui.png 1536w,\n/static/ad7deb0fb5251775bde96d2f37ccf18a/f537a/detail-ui.png 1730w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/ad7deb0fb5251775bde96d2f37ccf18a/fe486/detail-ui.png\"\n            alt=\"detail ui\"\n            title=\"detail ui\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<br/>\n<p>여기서 <code class=\"language-text\">Mark as Complete</code>의 체크박스를 클릭하면, DB에 데이터가 반영되는 구조다.<br>\n<strong>날짜 정보 역시 업데이트 시킨다.</strong></p>\n<br/>\n<p><img src=\"/cb9fd633f3d5c303f3b32261e03885c4/No-throttling.gif\" alt=\"No throttling\"></p>\n<p>테스트해보니, 생각보다.. 업데이트 반응이 느리지 않았다.<br>\n하지만 이는 데스크탑 상황이다.<br>\n데스크탑보다 모바일 성능은 당연히 떨어지며, 반응 역시 느려진다.</p>\n<p>모바일 환경이라고 가정해보고 테스트를 해보면 다음과 같다.<br>\n(네트워크탭에서 no throtting를 <strong>Fast 3G</strong>로 변경했다.)</p>\n<p><img src=\"/a0719599b7ec91abfafe9e2aa6916b0f/fast-3g.gif\" alt=\"\"><br>\n확연히 반응속도가 느린 것을 알 수 있었다.<br>\n그럼 이제 낙관적 업데이트로 이를 개선해보자.</p>\n<br/>\n<p>Tanstack-query v5 공식문서에선 두 가지 낙관적 업데이트(optimistic updates) 방법을 제시한다.</p>\n<h3 id=\"1-via-the-ui\" style=\"position:relative;\"><a href=\"#1-via-the-ui\" aria-label=\"1 via the ui permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Via the UI</h3>\n<p>이 방법은 비교적 간단한 방법으로 cache의 직접적인 변경없이도 구현이 가능했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">MUTATION_KEY</span> <span class=\"token operator\">=</span> <span class=\"token string\">'detail'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// useToggleOptimistic.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useToggleOptimistic</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> queryClient <span class=\"token operator\">=</span> <span class=\"token function\">useQueryClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> toggleMutation <span class=\"token operator\">=</span> <span class=\"token function\">useMutation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    mutationFn<span class=\"token operator\">:</span> changeToggle<span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">onSuccess</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n      toast<span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token string\">'성공적으로 업데이트 하였습니다!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">/**\n      return queryClient.invalidateQueries({\n        queryKey: ['detail'],\n      });\n      */</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">onSettled</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 반드시 return 시켜줘야함</span>\n      <span class=\"token comment\">// 쿼리를 무효화할 때 프로미스를 반환한다.</span>\n      <span class=\"token comment\">// 무효화가 완료되기 전까지 pening가 유지되도록 함</span>\n      <span class=\"token keyword\">return</span> queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">invalidateQueries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        queryKey<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'detail'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    mutationKey<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token constant\">MUTATION_KEY</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> toggleMutation<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>이 소스코드에서 크게 두 가지를 살펴보자.</p>\n<p><strong>1. onSettled</strong></p>\n<ul>\n<li>\n<p>보통 mutation의 onSuccess 내에서 invalidateQueies를 통해 캐시를 무효화시킨다.</p>\n</li>\n<li>\n<p>하지만 낙관적 업데이트를 하기 위해선, onSettled에서 invalidateQueries를 작성해주었다.<br>\n이 둘의 차이점은,</p>\n<ul>\n<li><code class=\"language-text\">onSuccess</code>는 mutation이 <strong>성공하고 결과를 전달할 때 실행</strong></li>\n<li><code class=\"language-text\">onSettled</code>는 mutation이 <strong>성공하든 실패하든 모두 실행</strong></li>\n</ul>\n</li>\n<li>\n<p>주의할 점은, onSettled에서 invalidateQueries로 캐시를 무효화할 땐, <strong><a href=\"https://tkdodo.eu/blog/mastering-mutations-in-react-query#awaited-promises\" target=\"_blank\" rel=\"nofollow\">꼭 return을 붙여줘야한다.</a></strong></p>\n<ul>\n<li>이는 promise를 반환할 때, pending상태임을 인지하기 위해서다.</li>\n</ul>\n</li>\n</ul>\n<br/>\n<p><strong>2. mutationKey</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">DetailPage</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//...</span>\n  <span class=\"token keyword\">const</span> toggleMutation <span class=\"token operator\">=</span> <span class=\"token function\">useToggleOptimistic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> pendingData <span class=\"token operator\">=</span> <span class=\"token function\">useMutationState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    filters<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> mutationKey<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token constant\">MUTATION_KEY</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> status<span class=\"token operator\">:</span> <span class=\"token string\">'pending'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// mutationKey를 통해 pending filter</span>\n    <span class=\"token function-variable function\">select</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>mutation<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mutation'</span><span class=\"token punctuation\">,</span> mutation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 하단 스크린샷</span>\n      <span class=\"token keyword\">return</span> mutation<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>variables <span class=\"token keyword\">as</span> DetailData<span class=\"token punctuation\">;</span> <span class=\"token comment\">//</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'toggleMutation'</span><span class=\"token punctuation\">,</span> toggleMutation<span class=\"token punctuation\">.</span>isPending<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// fasle → true → false</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'pendingData'</span><span class=\"token punctuation\">,</span> pendingData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// [] → [{...}] → []</span>\n\n<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n   <span class=\"token comment\">//...</span>\n <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>\n<p>사용자가 체크박스를 클릭했다고 가정해보자</p>\n</li>\n<li>\n<p>이때, toggleMutation은 false인 상태에서<br>\n→ api 요청이 갔을 것이고, pending 상태가 된다. 이때 true로 변경된다.<br>\n→ response 이후엔 다시 false로 변경된다.</p>\n</li>\n<li>\n<p>pendingData 역시 마찬가지다. 빈 배열인 상태에서<br>\n→ api 요청이 갔을 것이고, pending 상태인 데이터가 발생한다. 이때 mutationKey로 이를 filter한다.<br>\n→ 그리고 해당 mutation.state.variables를 가져오는 것이다.</p>\n</li>\n</ul>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ad3cc6f8f620ca77b9fbb13916f10951/d9f65/mutationKey.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA/klEQVQoz5WQWWvDMBCE8///VKFPLX1poaWBHM7hOiGOYluSJVWy9BW7bfKQA7IwLHvMMLsj6xyyFBTvE8pNiW81TkmcVhhjaFuDtRbnHN77Ifd1P1NKHfshBLwPjADc+JPy8Qm1WuBWGS5fEhYTfF3hYyIcCad8LQbBsF6yn37RHCSxX06JWAloqt+tlM6IKaWLGARjkbN7nbHPNrjQEfqmlqTmQLpB/hc+d5hN2L28IaZzttkKLSrSNoc/wUsOb56siw3FwzPiY0y9XhDEDmRN6sJNh1dPNtqwneWUe0GjNd9dRzx9i3tiJJWiqhtq1WKMRUo1wFpHTBBjugs/ZkJwjuElQlgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/ad3cc6f8f620ca77b9fbb13916f10951/a59e9/mutationKey.webp 192w,\n/static/ad3cc6f8f620ca77b9fbb13916f10951/0ca9f/mutationKey.webp 384w,\n/static/ad3cc6f8f620ca77b9fbb13916f10951/dc9b9/mutationKey.webp 768w,\n/static/ad3cc6f8f620ca77b9fbb13916f10951/e2c2f/mutationKey.webp 1152w,\n/static/ad3cc6f8f620ca77b9fbb13916f10951/f3efb/mutationKey.webp 1536w,\n/static/ad3cc6f8f620ca77b9fbb13916f10951/fca01/mutationKey.webp 2044w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/ad3cc6f8f620ca77b9fbb13916f10951/3b721/mutationKey.png 192w,\n/static/ad3cc6f8f620ca77b9fbb13916f10951/66595/mutationKey.png 384w,\n/static/ad3cc6f8f620ca77b9fbb13916f10951/fe486/mutationKey.png 768w,\n/static/ad3cc6f8f620ca77b9fbb13916f10951/d2d74/mutationKey.png 1152w,\n/static/ad3cc6f8f620ca77b9fbb13916f10951/e8464/mutationKey.png 1536w,\n/static/ad3cc6f8f620ca77b9fbb13916f10951/d9f65/mutationKey.png 2044w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/ad3cc6f8f620ca77b9fbb13916f10951/fe486/mutationKey.png\"\n            alt=\"select 메서드 내에서 mutation을 console.log 찍었을 때\"\n            title=\"select 메서드 내에서 mutation을 console.log 찍었을 때\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">select 메서드 내에서 mutation을 console.log 찍었을 때</figcaption>\n  </figure></p>\n<p>어떤 것을 사용해도 상관없다는 의미다.<br>\n하지만, query와 mutation이 한 컴포넌트에 존재하지 않을 땐,<br>\nuseMutationState를 사용해서 pending 상태인지를 확인할 수 있다.</p>\n<br/>\n<p>그럼 이제 UI에 반영해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">DetailPage</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> id <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useParams</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> detail <span class=\"token operator\">=</span> <span class=\"token function\">useDetailDataGetQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> toggleMutation <span class=\"token operator\">=</span> <span class=\"token function\">useToggleOptimistic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> pendingData <span class=\"token operator\">=</span> <span class=\"token function\">useMutationState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    filters<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> mutationKey<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token constant\">MUTATION_KEY</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> status<span class=\"token operator\">:</span> <span class=\"token string\">'pending'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">select</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>mutation<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mutation'</span><span class=\"token punctuation\">,</span> mutation<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> mutation<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>variables <span class=\"token keyword\">as</span> DetailData<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> pending <span class=\"token operator\">=</span> pendingData <span class=\"token operator\">?</span> pendingData<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// console.log('toggleMutation', toggleMutation.isPending);</span>\n  <span class=\"token comment\">// console.log('pendingData', pendingData);</span>\n\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>mx-auto max-w-4xl px-4 py-8 sm:px-6 lg:px-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Checkbox</span></span>\n        <span class=\"token attr-name\">checked</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>pending <span class=\"token operator\">?</span> pending<span class=\"token punctuation\">.</span>done <span class=\"token operator\">:</span> detail<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>done<span class=\"token punctuation\">}</span></span>\n        <span class=\"token comment\">// checked={detail.data.done}</span>\n        <span class=\"token attr-name\">onCheckedChange</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span>checked<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          toggleMutation<span class=\"token punctuation\">.</span><span class=\"token function\">mutate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            id<span class=\"token operator\">:</span> detail<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>\n            done<span class=\"token operator\">:</span> checked<span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token punctuation\">{</span>pending <span class=\"token operator\">?</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Label</span></span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>opacity-20<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">htmlFor</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>complete<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          Mark as Complete\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Label</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Label</span></span> <span class=\"token attr-name\">htmlFor</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>complete<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Mark as Complete</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Label</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><small>prettier이 왜 깨지는지 모르겠네..</small></p>\n<ul>\n<li>checkbox에서 pending이 true일 경우, pending.done을,<br>\npending이 false일 경우, query에서 가져온 데이터로 checkbox 상태를 관리한다.</li>\n</ul>\n<p><img src=\"/c06894d97011ba69aec3855337c801c5/optimistic-update.gif\" alt=\"체크박스가 훨씬 부드럽게 동작한다.\"></p>\n<ul>\n<li>UI로 명확히 확인하고자, <strong>pending 상태일 때</strong> Mark as Complete 문구에 <strong>opacity를 주었고</strong>,<br>\n<strong>Fast 3G</strong>로 테스트했다.</li>\n</ul>\n<br/>\n<h3 id=\"2-via-the-cache\" style=\"position:relative;\"><a href=\"#2-via-the-cache\" aria-label=\"2 via the cache permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Via the cache</h3>\n<p>이제 직접적인 두 번째 방법인 cache를 수동으로 변경시켜보자.<br>\n낙관적 업데이트의 핵심은 동일하다.<br>\n(응답을 기다리기 전 미리 UI를 업데이트 시키는 것)</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// useToggleOptimisticCache.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useToggleOptimisticCache</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> queryClient <span class=\"token operator\">=</span> <span class=\"token function\">useQueryClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> toggleMutation <span class=\"token operator\">=</span> <span class=\"token function\">useMutation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    mutationFn<span class=\"token operator\">:</span> changeToggle<span class=\"token punctuation\">,</span>\n\n    <span class=\"token function-variable function\">onMutate</span><span class=\"token operator\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>newData<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> newDataId <span class=\"token operator\">=</span> newData<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n     <span class=\"token comment\">// queryKey에 해당하는 데이터 업데이트를 취소시킨다.</span>\n      <span class=\"token keyword\">await</span> queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">cancelQueries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> queryKey<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'detail'</span><span class=\"token punctuation\">,</span> newDataId<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n     <span class=\"token comment\">// 그리고 기존의 queryKey에 해당하는 데이터를 가져온다.</span>\n      <span class=\"token keyword\">const</span> previousData <span class=\"token operator\">=</span> queryClient<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">getQueryData</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>DetailData<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n        <span class=\"token string\">'detail'</span><span class=\"token punctuation\">,</span>\n        newDataId<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n     <span class=\"token comment\">// 새로운 데이터 객체를 생성하여, 기존 데이터에 변경사항을 적용한다.</span>\n      <span class=\"token keyword\">const</span> updatedData <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>previousData<span class=\"token punctuation\">,</span>\n        done<span class=\"token operator\">:</span> newData<span class=\"token punctuation\">.</span>done<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n     <span class=\"token comment\">// 새로운 데이터를 cache에 적용한다.</span>\n      queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">setQueryData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'detail'</span><span class=\"token punctuation\">,</span> newDataId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> updatedData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        previousData<span class=\"token punctuation\">,</span>\n        newData<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token function-variable function\">onError</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">,</span> newData<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// mutation이 실패했을 때, 이전 데이터를 다시 반영한다.</span>\n      queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">setQueryData</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span><span class=\"token string\">'detail'</span><span class=\"token punctuation\">,</span> context<span class=\"token operator\">?.</span>newData<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        context<span class=\"token operator\">?.</span>previousData<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token function-variable function\">onSuccess</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      toast<span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token string\">'성공적으로 업데이트 하였습니다!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token function-variable function\">onSettled</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">invalidateQueries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        queryKey<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'detail'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> toggleMutation<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>공식문서에도 잘 작성되어있지만 하나씩 살펴보자.</p>\n<p><strong>1. onMutate</strong></p>\n<ul>\n<li>먼저, onMutate를 작성해줘야한다. 이는 mutate가 call될 때 동작한다.</li>\n<li>newData는 mutate에서 인자로 넘긴 value가 포함된다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\">  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Checkbox</span></span>\n    <span class=\"token comment\">//...</span>\n    <span class=\"token attr-name\">onCheckedChange</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span>checked<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      toggleMutation<span class=\"token punctuation\">.</span><span class=\"token function\">mutate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        id<span class=\"token operator\">:</span> detail<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>\n        done<span class=\"token operator\">:</span> checked<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n  <span class=\"token punctuation\">/></span></span></code></pre></div>\n<ul>\n<li>위 함수에서, id와 done을 넘겼으니, newData는 id와 done을 받게 된다.</li>\n</ul>\n<br/>\n<p>소스코드에도 작성되어있지만, 간략히 다시 설명하자면 다음과 같다.</p>\n<ul>\n<li>onMutate에서 queryKey에 해당하는 mutate를 취소한다. (cancelQueries)</li>\n<li>그리고 변경되기 전 데이터를 가져온다. (getQueryData)</li>\n<li>업데이트된 객체를 생성한 뒤, 수동으로 cache를 업데이트 시킨다. (setQueryData)</li>\n</ul>\n<br/>\n<p><strong>2. onError</strong></p>\n<p>에러가 발생했을 땐 어떻게 동작할까?</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// api/toggle/[id]/route.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token constant\">POST</span><span class=\"token punctuation\">(</span>request<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 일시적인 오류를 발생시켜보았다.</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'일시적 오류 발생!!!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">handleErrorResponse</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// useToggleOptimisticCache.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useToggleOptimisticCache</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> toggleMutation <span class=\"token operator\">=</span> <span class=\"token function\">useMutation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//...</span>\n    <span class=\"token function-variable function\">onError</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">,</span> newData<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'newData'</span><span class=\"token punctuation\">,</span> newData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'context'</span><span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">setQueryData</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span><span class=\"token string\">'detail'</span><span class=\"token punctuation\">,</span> context<span class=\"token operator\">?.</span>newData<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        context<span class=\"token operator\">?.</span>previousData<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">onSettled</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"onSettled 실행\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">invalidateQueries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        queryKey<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'detail'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> toggleMutation<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/703cf19d39072bd08a33ed0087ce3166/cb866/error-log.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.1875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABxElEQVQ4y42T2W7bMBBF9f9f1eeiKJqHoK6t2LG1ULJWihIlkSJPYRVO4iQuMsDFEMTF8HCGDPT+CbHbIp5TDoeC3Vaw250JwzMPj2LNF+33JXWU0KcxMo7oRYJKE4ZMrNmrDqcUgV0WWik5RTFxkrDfH9iFT+zCkFMUrfvPxxPH4xGpNElliYqZUzGTVoZCWkRtyeqJxTkCYyypyGgaiewU2iyoQdNKRVZpej3jPSzOM1uHGh396FB6eV2veVk9wTwb8jynU4ryXJIfEkpxRvU9nepRqkd2HcMwUNUSu3juxeXgwHvPRZcwxpB931DsBc1gcc69MTu8c1z9n+kSwU15oCsbpBrox5nJmJV0tvYdicdf8zvdEGrVE//YkP78Q/7rN7oskHnO2DTrBJe2xU3TS9HP4h+hfzW0YUorKmQl8XqAUeOHnqWTLG3ztYJvKattRC1qzDTjtF779rH59wcTeH9bsN7GRN8eqMKYab1qh5vnD82/N5iXHl5JuqigCWPUIWYpC2wSY6vyDdl9utspX56NteSxIM8yCpFyThLCzQbVdf+luiG01lI37fpLzkWJHidmY5mMZZwNvR5xHpzzX9Jf/vnw3ZGPf3wAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/703cf19d39072bd08a33ed0087ce3166/a59e9/error-log.webp 192w,\n/static/703cf19d39072bd08a33ed0087ce3166/0ca9f/error-log.webp 384w,\n/static/703cf19d39072bd08a33ed0087ce3166/dc9b9/error-log.webp 768w,\n/static/703cf19d39072bd08a33ed0087ce3166/dca56/error-log.webp 1056w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/703cf19d39072bd08a33ed0087ce3166/3b721/error-log.png 192w,\n/static/703cf19d39072bd08a33ed0087ce3166/66595/error-log.png 384w,\n/static/703cf19d39072bd08a33ed0087ce3166/fe486/error-log.png 768w,\n/static/703cf19d39072bd08a33ed0087ce3166/cb866/error-log.png 1056w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/703cf19d39072bd08a33ed0087ce3166/fe486/error-log.png\"\n            alt=\"error log\"\n            title=\"error log\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span><br>\n소스코드의 log처럼 차례로, error, newData, context이다.<br>\n위에서 언급한대로, onSettled는 mutation이 성공하든 실패하든 모두 실행된다.</p>\n<br/>\n<h3 id=\"3-어떤-상황에-쓰면-될까\" style=\"position:relative;\"><a href=\"#3-%EC%96%B4%EB%96%A4-%EC%83%81%ED%99%A9%EC%97%90-%EC%93%B0%EB%A9%B4-%EB%90%A0%EA%B9%8C\" aria-label=\"3 어떤 상황에 쓰면 될까 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 어떤 상황에 쓰면 될까?</h3>\n<p>마지막으로 두 가지 방법을 어떤 상황에 각각 쓰면 되는걸까?<br>\n공식문서에선 <a href=\"https://tanstack.com/query/latest/docs/framework/react/guides/optimistic-updates#when-to-use-what\" target=\"_blank\" rel=\"nofollow\">다음과 같이</a> 제시한다.</p>\n<ul>\n<li>UI를 직접 업데이트하는 곳이 <strong>한 곳만 있는 경우</strong> → via the UI</li>\n<li>UI를 직접 업데이트하는 곳이 <strong>두 곳 이상일 경우</strong> → via the cache</li>\n</ul>\n<br/>\n<p>현재의 예시에선 detail 페이지만 존재한다.<br>\ndetail 페이지 내의 checkbox 상태만 서버로 전송하고,<br>\n서버에선 checkbox 상태를 업데이트할 때 현재의 date도 같이 DB에 저장한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token constant\">POST</span><span class=\"token punctuation\">(</span>request<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">,</span> done <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> now <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// date 만들어서</span>\n\n     <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data<span class=\"token punctuation\">,</span> error <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> supabase\n      <span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token string\">'tasks'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> done<span class=\"token punctuation\">,</span> date<span class=\"token operator\">:</span> now <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 같이 보낸다.</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">single</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//...</span>\n    <span class=\"token keyword\">return</span> NextResponse<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> message<span class=\"token operator\">:</span> <span class=\"token string\">'Update successful'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">handleErrorResponse</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그래서 이 경우엔 via the UI를 사용하면 될 듯하다.<br>\n왜냐하면, 직접 업데이트 되는 곳이 detail 페이지 한 곳이기 때문이다.</p>\n<p>만약 detail 페이지 내 리스트를 가져와서 뿌려주는 table이 있다고 가정해보자.<br>\n각 query는 분리되어있다. (detail과 table query)</p>\n<p>이때 체크박스를 업데이트 하면, 날짜가 table내 한 컬럼에도 표시되어야하고, 업데이트도 되어야한다.\n한 걸음 더 나아가, 낙관적 업데이트를 적용했다고 가정해보자.</p>\n<br/>\n<p>이런 경우라면, via the cache방법으로 cache를 수동적으로 각각 업데이트 시켜줘야한다.</p>\n<br/>\n<h3 id=\"번외\" style=\"position:relative;\"><a href=\"#%EB%B2%88%EC%99%B8\" aria-label=\"번외 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>번외</h3>\n<p>3번의 예시를 하나하나 다 만들기엔 시간이 부족해서.. 🥲 최대한 만들었던 것을 재활용해서 작성해봤다.</p>\n<ol>\n<li>detail페이지 내 table이 추가되었다.</li>\n<li>detail페이지에서 체크박스의 상태와 날짜를 낙관적 업데이트한다.</li>\n<li>이때, table 내 한 컬럼의 날짜업데이트도 cache를 수동적으로 변경해서 적용해보자.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useToggleOptimisticCache</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> queryClient <span class=\"token operator\">=</span> <span class=\"token function\">useQueryClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> toggleMutation <span class=\"token operator\">=</span> <span class=\"token function\">useMutation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    mutationFn<span class=\"token operator\">:</span> changeToggle<span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">onMutate</span><span class=\"token operator\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>newData<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> newDataId <span class=\"token operator\">=</span> newData<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">await</span> queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">cancelQueries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> queryKey<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'detail'</span><span class=\"token punctuation\">,</span> newDataId<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">await</span> queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">cancelQueries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> queryKey<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'table'</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">const</span> previousDetail <span class=\"token operator\">=</span> queryClient<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">getQueryData</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>DetailData<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n        <span class=\"token string\">'detail'</span><span class=\"token punctuation\">,</span>\n        newDataId<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">const</span> updatedDetail <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>previousDetail<span class=\"token punctuation\">,</span>\n        done<span class=\"token operator\">:</span> newData<span class=\"token punctuation\">.</span>done<span class=\"token punctuation\">,</span>\n        date<span class=\"token operator\">:</span> newData<span class=\"token punctuation\">.</span>date<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n      queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">setQueryData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'detail'</span><span class=\"token punctuation\">,</span> newDataId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> updatedDetail<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// table에 해당하는 데이터 중, detail과 동일한 id찾아 체크박스와 date를 업데이트 한다.</span>\n      queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">setQueryData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'table'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>oldData<span class=\"token operator\">:</span> DetailData<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> oldData<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> newData<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>item<span class=\"token punctuation\">,</span> done<span class=\"token operator\">:</span> newData<span class=\"token punctuation\">.</span>done<span class=\"token punctuation\">,</span> date<span class=\"token operator\">:</span> newData<span class=\"token punctuation\">.</span>date <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n\n          <span class=\"token keyword\">return</span> item<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        previousDetail<span class=\"token punctuation\">,</span>\n        newData<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token function-variable function\">onError</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">,</span> newData<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">setQueryData</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">[</span><span class=\"token string\">'detail'</span><span class=\"token punctuation\">,</span> context<span class=\"token operator\">?.</span>newData<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        context<span class=\"token operator\">?.</span>previousDetail<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">setQueryData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'table'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>oldTable<span class=\"token operator\">:</span> DetailData<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> oldTable<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> item<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> context<span class=\"token operator\">?.</span>newData<span class=\"token punctuation\">.</span>id\n            <span class=\"token operator\">?</span> context<span class=\"token operator\">?.</span>previousDetail\n            <span class=\"token operator\">:</span> item<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token function-variable function\">onSuccess</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      toast<span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token string\">'성공적으로 업데이트 하였습니다!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token function-variable function\">onSettled</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// detail과 table 모두 무효화 시키기</span>\n      queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">invalidateQueries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        queryKey<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'detail'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      queryClient<span class=\"token punctuation\">.</span><span class=\"token function\">invalidateQueries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        queryKey<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'table'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> toggleMutation<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>마지막으로 잘 되는지 테스트해보자.<br>\n참고로 DB에 저장할 땐 UTC기준으로 사용했고, UI로 보여주는 시간은 한국시간 기준으로 적용되어있다.<br>\n즉, 9시간 차이가 난다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f90d8b1093956a2659e53876dcf16f1c/f6d0e/optimistic-table-detail.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.708333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABZklEQVQoz42RTW7bMBCFdf8T5AzNsnco0FWBoJuisZPCSm1TEskZUtRPJH8FKTv9WQQl8DDkzMObmcfqcrmwriv5pJTY75+pDzV935dcrmXOho2nqogI0zQBl9/1daValoWMfNr9jo93d3y6/8CUEuu1Wa7Pr69s3JVhGEnDwDzPLNd6zmfRyolineI1IF6xbYdYTwiRoIKI4rzStBYNfUGIiRgTIV7f1/zx3FKZ7484KzSdx/mA10jsh0IWDXROcE4IITDNc1nzhvl2nyfGcaTpHFWsD8W7skYaCvo+0eeYhkK0Xvl5at+m9U5L886H7e0VDRHrhGpalr+6/ovsk2jkR21ojcFaj+sEa5VzFraCdO7NhipP8B6yaN7gZDqORnGa8KHHS0AklOglbnZJoHpvupvgMI6Y44n624GXxxrzcsI0jnPjSrzdWyv/ITiOpGnCPD1z/PwF9/AV2e3Kr2Yr/kT+7V+f0bQ14ByZhwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f90d8b1093956a2659e53876dcf16f1c/a59e9/optimistic-table-detail.webp 192w,\n/static/f90d8b1093956a2659e53876dcf16f1c/0ca9f/optimistic-table-detail.webp 384w,\n/static/f90d8b1093956a2659e53876dcf16f1c/dc9b9/optimistic-table-detail.webp 768w,\n/static/f90d8b1093956a2659e53876dcf16f1c/e2c2f/optimistic-table-detail.webp 1152w,\n/static/f90d8b1093956a2659e53876dcf16f1c/f3efb/optimistic-table-detail.webp 1536w,\n/static/f90d8b1093956a2659e53876dcf16f1c/e1b4c/optimistic-table-detail.webp 2974w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f90d8b1093956a2659e53876dcf16f1c/3b721/optimistic-table-detail.png 192w,\n/static/f90d8b1093956a2659e53876dcf16f1c/66595/optimistic-table-detail.png 384w,\n/static/f90d8b1093956a2659e53876dcf16f1c/fe486/optimistic-table-detail.png 768w,\n/static/f90d8b1093956a2659e53876dcf16f1c/d2d74/optimistic-table-detail.png 1152w,\n/static/f90d8b1093956a2659e53876dcf16f1c/e8464/optimistic-table-detail.png 1536w,\n/static/f90d8b1093956a2659e53876dcf16f1c/f6d0e/optimistic-table-detail.png 2974w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f90d8b1093956a2659e53876dcf16f1c/fe486/optimistic-table-detail.png\"\n            alt=\"optimistic table detail\"\n            title=\"optimistic table detail\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>table 내 detail id와 동일한 table의 date가 잘 반영된다.</p>\n<br/>\n<h3 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"headerElement before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h3>\n<ol>\n<li>\n<p>앞으로 낙관적 업데이트를 적용할 일이 어떤 경우가 있을지 모르겠다.<br>\n하지만, 적용하게 된다면 <strong>via the UI를 가장 우선 고려할 것 같다.</strong><br>\n수동으로 cache를 조작하는 것보다 방법이 편하고 되돌리기도 용이하다.<br>\n심지어 코드량도 적게 사용할 수 있다.</p>\n</li>\n<li>\n<p>예시를 만들면서 detail페이지의 UI는 <a href=\"https://v0.dev/\" target=\"_blank\" rel=\"nofollow\">v0</a>가 만들어줬다.<br>\n쉽고 간단하게 코드만 복붙해서 내가 원하는대로 커스텀하기 편했다.<br>\n프리미엄은.. 결제해보고 싶었다.</p>\n</li>\n<li>\n<p>tanstack 라이브러리는 배울게 많다.<br>\n소스코드를 확인해보지 않아서 모르겠지만, core를 두고<br>\nreact에 주입하면 react용으로 사용되고,<br>\nvue에 주입하면 vue용으로 사용되는 것 같다.<br>\n이 부분은 차츰차츰 알아가보자!</p>\n</li>\n</ol>","tableOfContents":"<ul>\n<li><a href=\"#%EB%82%99%EA%B4%80%EC%A0%81-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8optimistic-updates%EB%8A%94-%EC%96%B4%EB%96%A8-%EB%95%8C-%EC%82%AC%EC%9A%A9%ED%95%A0%EA%B9%8C\">낙관적 업데이트(Optimistic updates)는 어떨 때 사용할까?</a></li>\n<li><a href=\"#1-via-the-ui\">1. Via the UI</a></li>\n<li><a href=\"#2-via-the-cache\">2. Via the cache</a></li>\n<li><a href=\"#3-%EC%96%B4%EB%96%A4-%EC%83%81%ED%99%A9%EC%97%90-%EC%93%B0%EB%A9%B4-%EB%90%A0%EA%B9%8C\">3. 어떤 상황에 쓰면 될까?</a></li>\n<li><a href=\"#%EB%B2%88%EC%99%B8\">번외</a></li>\n<li><a href=\"#%EC%A0%95%EB%A6%AC\">정리</a></li>\n</ul>","frontmatter":{"title":"예시로 살펴보는 낙관적 업데이트(optimistic updates) 2가지 방법","summary":"낙관적이네..","date":"2024.04.21.","categories":["개발"]}}}]}},"pageContext":{"slug":"/blog/2024/4/20/query-optimistic/"}},"staticQueryHashes":["1629908903"]}